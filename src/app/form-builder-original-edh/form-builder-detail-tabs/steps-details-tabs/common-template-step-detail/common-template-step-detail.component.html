<div class="p-grid">
  <div style="text-align: start" class="p-col-1">
    <button matTooltip="{{ 'LEAVE' | translate }}" mat-raised-button color="warn" style="padding-left: 10px" (click)="leave()">
      <mat-icon class="mat-icon-default">keyboard_arrow_left</mat-icon>
      {{ 'LEAVE' | translate }}
    </button>
  </div>
  <div class="p-col-5 text-end-no-pad-r" [formGroup]="templateStepForm">
    <button matTooltip="{{ 'Save' | translate }}" mat-raised-button color="accent" [disabled]="isPublished" (click)="saveStepData()">
      <mat-icon class="mat-icon-default">save</mat-icon>
      {{ 'Save' | translate }}
    </button>
  </div>
</div>

<div class="p-grid">
  <div class="p-col-6 form-side" style="margin-top: 2rem">
    <fieldset style="padding: 0; border: none">
      <div [formGroup]="templateStepForm" class="p-grid yellow-border card-row">
        <div class="section-header">
          <h3>{{ templateStepForm?.get('step_title').value }}</h3>
        </div>

        <div class="p-col-12">
          <div class="p-grid">
            <div class="p-col-12 no-padding-y custom-css">
              <mat-form-field class="full-width">
                <input
                  type="text"
                  formControlName="step_title"
                  matInput
                  required
                  placeholder="{{ 'FORM_BUILDER.Step Title' | translate }}"
                  ngModel
                  maxlength="150"
                />
              </mat-form-field>
              <mat-error>
                <p
                  *ngIf="
                    templateStepForm?.get('step_title').hasError('required') &&
                    (templateStepForm?.get('step_title').dirty || templateStepForm?.get('step_title').touched)
                  "
                >
                  {{ 'This field is required' | translate }}
                </p>
              </mat-error>
            </div>
          </div>

          <div class="p-grid">
            <div class="p-col-12 no-padding-y">
              <ng-select
                placeholder="{{ 'FORM_BUILDER.Step Type' | translate }}*"
                formControlName="step_type"
                [clearable]="false"
                (change)="handleStepCondition()"
                [disabled]="isPublished"
                dropdownPosition="bottom"
              >
                <ng-option *ngFor="let stepType of stepTypeList" [value]="stepType">{{ 'FORM_BUILDER.' + stepType | translate }}</ng-option>
              </ng-select>
              <mat-error>
                <p
                  *ngIf="
                    templateStepForm?.get('step_type').hasError('required') &&
                    (templateStepForm?.get('step_type').dirty || templateStepForm?.get('step_type').touched)
                  "
                >
                  {{ 'This field is required' | translate }}
                </p>
              </mat-error>
            </div>
          </div>

          <div class="p-grid">
            <div class="p-col-12 no-padding-y">
              <div *ngIf="templateStepForm?.get('direction')" class="ckeditor">
                <div class="p-grid">
                  <div class="p-col-6">
                    <label>{{ 'Header/Direction' | translate }}</label>
                  </div>
                  <ng-container>
                    <div class="p-col-6" style="text-align: end">
                      <button
                        (click)="openTableKey(templateStepForm?.get('step_type').value)"
                        matTooltip="{{ 'List of keys' | translate }}"
                        mat-raised-button
                        color="accent"
                      >
                        <mat-icon class="mat-icon-default">save</mat-icon>
                        {{ 'List of keys' | translate }}
                      </button>
                    </div>
                  </ng-container>
                </div>
                <ckeditor
                  #editor
                  [editor]="Editor"
                  [formControl]="templateStepForm?.controls['direction']"
                  (ready)="onReady($event)"
                  [config]="config"
                  [disabled]="isPublished"
                ></ckeditor>
              </div>
            </div>
          </div>
        </div>

        <div class="p-col-12 text-end-no-pad-r">
          <button
            *ngIf="
              templateStepForm?.get('step_type').value === 'question_and_field' ||
              templateStepForm?.get('step_type').value === 'modality_payment' ||
              templateStepForm?.get('step_type').value === 'academic_journey'
            "
            matTooltip="{{ 'FORM_BUILDER.Add Segment' | translate }}"
            mat-raised-button
            color="accent"
            [disabled]="!templateStepForm?.get('step_type').value"
            (click)="addSegmentForm('Open Dialog')"
          >
            {{ 'FORM_BUILDER.Add Segment' | translate }}
          </button>
        </div>

        <div class="p-col-12 no-padding">
          <mat-accordion
            formArrayName="segments"
            [cdkDropListData]="getSegmentFormarray().controls"
            [multi]="true"
            cdkDropList
            (cdkDropListDropped)="dropSegment($event)"
          >
            <mat-expansion-panel
              *ngFor="let segment of getSegmentFormarray().controls; let segmentIndex = index"
              [formGroupName]="segmentIndex"
              style="background: #607d8b"
              [expanded]="true"
              cdkDrag
              [cdkDragDisabled]="
                isPublished ||
                templateStepForm?.get('step_type').value === 'campus_validation' ||
                templateStepForm?.get('step_type').value === 'step_summary'
              "
            >
              <mat-expansion-panel-header cdkDragHandle>
                <mat-panel-title>
                  <h4 style="color: white; align-self: center; margin: 0px">{{ segment.get('segment_title').value }}</h4>
                </mat-panel-title>
              </mat-expansion-panel-header>

              <!-- Delete segment does not exist in step condition acceptance and document expected -->
              <div
                class="p-grid panel-divider"
                *ngIf="
                  templateStepForm?.get('step_type').value === 'question_and_field' ||
                  templateStepForm?.get('step_type').value === 'modality_payment' ||
                  templateStepForm?.get('step_type').value === 'academic_journey'
                "
              >
                <div class="p-col-11"></div>
                <div class="p-col-1 text-right no-padding">
                  <button (click)="removeSegmentForm(segmentIndex)" mat-icon-button class="small-icon" color="red">
                    <mat-icon>remove</mat-icon>
                  </button>
                </div>
              </div>

              <div class="p-grid custom-css">
                <!-- Segment title doesn't exist in step document expected -->
                <ng-container>
                  <div class="p-col-12">
                    <mat-form-field color="accent">
                      <input
                        #blockPanel
                        type="text"
                        formControlName="segment_title"
                        matInput
                        required
                        placeholder="{{ 'FORM_BUILDER.Segment Title' | translate }}"
                      />
                    </mat-form-field>
                  </div>
                </ng-container>

                <ng-container *ngIf="templateStepForm?.get('step_type').value === 'modality_payment'">
                  <div class="p-col-12">
                    <mat-slide-toggle formControlName="is_student_included">
                      {{ 'Include student as financial support' | translate }}
                    </mat-slide-toggle>
                  </div>

                  <div class="p-col-12 text-end-no-pad-r" *ngIf="segment.get('is_student_included').value === true">
                    <button
                      matTooltip="{{ 'FORM_BUILDER.Add Question' | translate }}"
                      mat-raised-button
                      color="accent"
                      (click)="addQuestionFieldForm(segmentIndex, 'student'); scrollIntoLastQuestion(segmentIndex)"
                    >
                      {{ 'FORM_BUILDER.Add Question' | translate }}
                    </button>
                  </div>

                  <div
                    class="p-col-12 no-padding"
                    formArrayName="questions"
                    [cdkDropListData]="getQuestionFieldFormArray(segmentIndex).controls"
                    cdkDropList
                    (cdkDropListDropped)="dropQuestion($event, segmentIndex)"
                  >
                    <div *ngFor="let questionField of getQuestionFieldFormArray(segmentIndex).controls; let questionIndex = index">
                      <mat-card
                        *ngIf="questionField?.get('modality_question_type')?.value === 'student'"
                        class="mrgn-all-xs"
                        cdkDrag
                        [cdkDragDisabled]="
                          isPublished ||
                          templateStepForm?.get('step_type').value === 'campus_validation' ||
                          templateStepForm?.get('step_type').value === 'step_summary'
                        "
                      >
                        <div #questionPanel>
                          <!-- QUESTION TYPE: EXPECTED DOCUMENT AND FIELD BELOW ----------------------------------------------------------------------------------------------------->
                          <mat-card-content
                            *ngIf="templateStepForm?.get('step_type').value === 'document_expected'"
                            [formGroupName]="questionIndex"
                            cdkDragHandle
                          >
                            <div class="p-grid">
                              <!-- The toggles row -->
                              <div class="p-col-10" style="align-self: center; padding-bottom: 0px">
                                <!-- this slide hide for temporary; EDH can use it in the future -->
                                <!-- <mat-slide-toggle
                                    [disabled]="isPublished"
                                    formControlName="is_field"
                                    (change)="updateFieldToggle($event, segmentIndex, questionIndex)"
                                  >
                                    <span [ngClass]="{ 'text-slider-color': questionField?.get('is_field').value }">
                                      {{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD' | translate }}
                                    </span>
                                  </mat-slide-toggle> -->
                                <mat-slide-toggle formControlName="is_required" [disabled]="isPublished" style="margin-left: 1rem">
                                  <span [ngClass]="{ 'text-slider-color': questionField?.get('is_required').value }">
                                    {{
                                      (questionField?.get('is_required').value ? 'FORM_BUILDER.Required' : 'FORM_BUILDER.Not Required')
                                        | translate
                                    }}
                                  </span>
                                </mat-slide-toggle>
                              </div>
                              <div class="p-col-2" style="padding-bottom: 0px">
                                <div style="text-align: right">
                                  <button
                                    (click)="removeQuestionFieldForm(segmentIndex, questionIndex)"
                                    mat-icon-button
                                    class="small-icon"
                                    color="red"
                                  >
                                    <mat-icon>remove</mat-icon>
                                  </button>
                                </div>
                              </div>
                            </div>

                            <div class="p-grid">
                              <div class="p-col-8">
                                <ng-select
                                  placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.ANSWER_TYPE' | translate }}"
                                  formControlName="answer_type"
                                  [clearable]="false"
                                  appendTo="body"
                                  required
                                  [disabled]="isPublished"
                                >
                                  <ng-option
                                    *ngFor="let questionAnswerType of questionnaireConsts?.expectedDocumentTypes"
                                    [value]="questionAnswerType.value"
                                    >{{ 'EXPECTED_DOCUMENT_TYPES.' + questionAnswerType.view | translate }}</ng-option
                                  >
                                </ng-select>
                              </div>
                            </div>

                            <!-- Second row, question label, only if non-field -->
                            <div class="p-grid">
                              <div [style.display]="questionField?.get('is_field').value ? 'block' : 'none'" class="p-col-4">
                                <ng-select
                                  placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_TYPE' | translate }}"
                                  formControlName="field_type"
                                  [clearable]="false"
                                  appendTo="body"
                                  [required]="questionField?.get('is_field').value"
                                  [disabled]="isPublished"
                                  (change)="selectDocumentExpectedType($event, segmentIndex, questionIndex)"
                                >
                                  <ng-option
                                    [disabled]="isPublished"
                                    *ngFor="let field of questionnaireConsts?.documentExpectedFields"
                                    [value]="field"
                                    >{{ 'FORM_BUILDER_FIELD.' + field | translate }}</ng-option
                                  >
                                </ng-select>
                              </div>
                              <div [style.display]="!questionField?.get('is_field').value ? 'block' : 'none'" class="p-col-12 custom-css">
                                <mat-form-field>
                                  <input
                                    required
                                    matInput
                                    formControlName="question_label"
                                    [placeholder]="'Question Label' | translate"
                                    type="text"
                                  />
                                </mat-form-field>
                              </div>
                            </div>
                          </mat-card-content>

                          <!-- QUESTION TYPE: NORMAL QUESTION AND FIELD BELOW ----------------------------------------------------------------------------------------------------->
                          <mat-card-content
                            *ngIf="
                              templateStepForm?.get('step_type').value === 'question_and_field' ||
                              templateStepForm?.get('step_type').value === 'modality_payment' ||
                              templateStepForm?.get('step_type').value === 'academic_journey' ||
                              templateStepForm?.get('step_type').value === 'document_to_validate'
                            "
                            [formGroupName]="questionIndex"
                            cdkDragHandle
                          >
                            <div class="p-grid">
                              <ng-container *ngIf="templateStepForm?.get('step_type').value !== 'document_to_validate'">
                                <div class="p-col-10" style="align-self: center; padding-bottom: 0px">
                                  <mat-slide-toggle
                                    [disabled]="isPublished"
                                    formControlName="is_field"
                                    (change)="updateFieldToggle($event, segmentIndex, questionIndex)"
                                  >
                                    <span [ngClass]="{ 'text-slider-color': questionField?.get('is_field').value }">
                                      {{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD' | translate }}
                                    </span>
                                  </mat-slide-toggle>
                                  <mat-slide-toggle
                                    *ngIf="questionField?.get('is_field').value"
                                    style="margin-left: 1rem"
                                    formControlName="is_editable"
                                    (change)="updateEditableToggle($event, segmentIndex, questionIndex)"
                                    [disabled]="isPublished || checkFieldType(questionField.get('field_type').value)"
                                  >
                                    <span [ngClass]="{ 'text-slider-color': questionField?.get('is_editable').value }">
                                      {{
                                        (questionField?.get('is_editable').value ? 'FORM_BUILDER.Editable' : 'FORM_BUILDER.Not Editable')
                                          | translate
                                      }}
                                    </span>
                                  </mat-slide-toggle>
                                  <mat-slide-toggle
                                    *ngIf="questionField?.get('is_editable').value"
                                    style="margin-left: 1rem"
                                    formControlName="is_required"
                                    [disabled]="isPublished"
                                  >
                                    <span [ngClass]="{ 'text-slider-color': questionField?.get('is_required').value }">
                                      {{
                                        (questionField?.get('is_required').value ? 'FORM_BUILDER.Required' : 'FORM_BUILDER.Not Required')
                                          | translate
                                      }}
                                    </span>
                                  </mat-slide-toggle>
                                </div>
                                <div class="p-col-2" style="padding-bottom: 0px">
                                  <div style="text-align: right">
                                    <button
                                      (click)="removeQuestionFieldForm(segmentIndex, questionIndex)"
                                      mat-icon-button
                                      class="small-icon"
                                      color="red"
                                    >
                                      <mat-icon>remove</mat-icon>
                                    </button>
                                  </div>
                                </div>
                              </ng-container>
                            </div>

                            <div class="p-grid">
                              <!-- Display the answer type if field is false -->
                              <ng-container *ngIf="templateStepForm?.get('step_type').value !== 'document_to_validate'">
                                <div [style.display]="!questionField.get('is_field').value ? 'block' : 'none'" class="p-col-4">
                                  <mat-form-field>
                                    <input
                                      matInput
                                      formControlName="ref_id"
                                      [placeholder]="'ERP_009_TEACHER_CONTRACT.Ref Id' | translate"
                                      type="text"
                                      [required]="!questionField.get('is_field').value"
                                    />
                                  </mat-form-field>
                                </div>
                                <div [style.display]="!questionField.get('is_field').value ? 'block' : 'none'" class="p-col-4">
                                  <ng-select
                                    class="dropdown"
                                    placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.ANSWER_TYPE' | translate }}"
                                    formControlName="answer_type"
                                    [clearable]="false"
                                    appendTo="body"
                                    [required]="!questionField.get('is_field').value"
                                    (change)="checkAnswerType(segmentIndex, questionIndex)"
                                  >
                                    <ng-container *ngIf="templateType === 'admission_document'">
                                      <ng-option
                                        *ngFor="let questionAnswerType of questionnaireConsts.questionAnswerTypesAdmissionDocument"
                                        [value]="questionAnswerType.key"
                                        >{{ 'QUESTION_ANSWER_TYPE.' + questionAnswerType.name.toUpperCase() | translate }}</ng-option
                                      >
                                    </ng-container>
                                    <ng-container *ngIf="templateType !== 'admission_document'">
                                      <ng-option
                                        *ngFor="let questionAnswerType of questionnaireConsts.questionAnswerTypes"
                                        [value]="questionAnswerType.key"
                                        >{{ 'QUESTION_ANSWER_TYPE.' + questionAnswerType.name.toUpperCase() | translate }}</ng-option
                                      >
                                    </ng-container>
                                  </ng-select>
                                </div>
                              </ng-container>

                              <!-- Display the field dropdown if field is true -->
                              <ng-container *ngIf="templateStepForm?.get('step_type').value !== 'document_to_validate'">
                                <div [style.display]="questionField?.get('is_field').value ? 'block' : 'none'" class="p-col-4">
                                  <!-- <ng-select
                                      *ngIf="
                                        templateStepForm?.get('step_type').value !== 'modality_payment' ||
                                        templateStepForm?.get('step_type').value !== 'question_and_field'
                                      "
                                      placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_TYPE' | translate }}"
                                      formControlName="field_type"
                                      [clearable]="false"
                                      appendTo="body"
                                      [required]="questionField?.get('is_field').value"
                                      [disabled]="isPublished"
                                    >
                                      <ng-option
                                        [disabled]="isPublished"
                                        *ngFor="let field of questionnaireConsts?.questionnaireFields"
                                        [value]="field"
                                        >{{ 'FORM_BUILDER_FIELD.' + field | translate }}</ng-option
                                      >
                                    </ng-select> -->

                                  <!-- this field type for question_and_field type -->
                                  <ng-select
                                    *ngIf="templateStepForm?.get('step_type').value === 'question_and_field'"
                                    placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_TYPE' | translate }}*"
                                    formControlName="field_type"
                                    [clearable]="false"
                                    appendTo="body"
                                    [required]="questionField?.get('is_field').value"
                                    [disabled]="isPublished"
                                  >
                                    <!-- *ngFor="let field of questionnaireConsts?.questionAndFieldType" -->

                                    <ng-container *ngIf="templateType === 'alumni'">
                                      <ng-option
                                        [disabled]="isPublished"
                                        *ngFor="let field of questionnaireConsts?.questionnaireFieldsForAlumni"
                                        [value]="field"
                                      >
                                        {{ 'FORM_BUILDER_FIELD.' + field | translate }}
                                      </ng-option>
                                    </ng-container>

                                    <ng-container *ngIf="templateType === 'teacher_contract'">
                                      <ng-option
                                        [disabled]="isPublished"
                                        *ngFor="let field of questionnaireConsts?.questionnaireFieldsForTeacher"
                                        [value]="field"
                                      >
                                        {{ 'FORM_BUILDER_FIELD.' + field | translate }}
                                      </ng-option>
                                    </ng-container>

                                    <ng-container *ngIf="templateType === 'fc_contract'">
                                      <ng-option
                                        [disabled]="isPublished"
                                        *ngFor="let field of questionnaireConsts?.questionnaireFieldsForContract"
                                        [value]="field"
                                      >
                                        {{ 'FORM_BUILDER_FIELD.' + field | translate }}
                                      </ng-option>
                                    </ng-container>

                                    <ng-container *ngIf="templateType === 'student_admission'">
                                      <ng-option
                                        [disabled]="isPublished"
                                        *ngFor="let field of questionnaireConsts?.questionAndFieldType"
                                        [value]="field"
                                      >
                                        {{ 'FORM_BUILDER_FIELD.' + field | translate }}
                                      </ng-option>
                                    </ng-container>

                                    <!-- Field Admission Document -->
                                    <ng-container *ngIf="templateType === 'admission_document'">
                                      <ng-option
                                        [disabled]="isPublished"
                                        *ngFor="let field of questionnaireConsts?.questionAndFieldAdmissionDocumentType"
                                        [value]="field"
                                      >
                                        {{ 'FORM_BUILDER_FIELD.' + field | translate }}
                                      </ng-option>
                                    </ng-container>
                                  </ng-select>

                                  <!-- this field type for modality_payment type -->
                                  <ng-select
                                    *ngIf="templateStepForm?.get('step_type').value === 'modality_payment'"
                                    placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_TYPE' | translate }}"
                                    formControlName="field_type"
                                    [clearable]="false"
                                    appendTo="body"
                                    [required]="questionField?.get('is_field').value"
                                    [disabled]="isPublished"
                                  >
                                    <ng-option
                                      [disabled]="isPublished"
                                      *ngFor="let field of questionnaireConsts?.modalityPaymentFieldType"
                                      [value]="field"
                                      >{{ '031_FORMBUILDER_MODALITYPAYMENT_FIELD.' + field | translate }}</ng-option
                                    >
                                  </ng-select>
                                </div>
                              </ng-container>

                              <!-- Always display the position regardless field true/false -->
                              <ng-container *ngIf="templateStepForm?.get('step_type').value !== 'document_to_validate'">
                                <div class="p-col-4">
                                  <ng-select
                                    placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_POSITION' | translate }}*"
                                    formControlName="field_position"
                                    [clearable]="false"
                                    appendTo="body"
                                    required
                                    [disabled]="isPublished"
                                  >
                                    <ng-option *ngFor="let position of questionnaireConsts?.questionPositions" [value]="position">{{
                                      'FORM_BUILDER.POSITION.' + position | translate
                                    }}</ng-option>
                                  </ng-select>
                                </div>
                              </ng-container>

                              <!-- For Question Name, only displayed if field false -->
                              <ng-container *ngIf="templateStepForm?.get('step_type').value !== 'document_to_validate'">
                                <div
                                  [style.display]="
                                    !questionField.get('is_field').value &&
                                    ['single_option', 'single_option_diploma'].includes(questionField.get('answer_type').value)
                                      ? 'contents'
                                      : 'none'
                                  "
                                >
                                  <div class="p-col-12">
                                    <mat-slide-toggle formControlName="is_router_on">
                                      {{ questionField.get('is_router_on').value ? ('Router ON' | translate) : ('Router OFF' | translate) }}
                                    </mat-slide-toggle>
                                  </div>
                                </div>

                                <div [style.display]="!questionField?.get('is_field').value ? 'block' : 'none'" class="p-col-12">
                                  <mat-form-field>
                                    <input
                                      matInput
                                      formControlName="question_label"
                                      [placeholder]="'Question Label' | translate"
                                      type="text"
                                      [required]="!questionField?.get('is_field').value"
                                    />
                                  </mat-form-field>
                                </div>
                              </ng-container>
                            </div>

                            <div
                              fxLayout="row"
                              *ngIf="
                                questionField &&
                                checkIsParentChild(questionField.value) &&
                                templateStepForm?.get('step_type').value !== 'document_to_validate'
                              "
                            >
                              <div class="p-col-8">
                                <mat-form-field color="accent">
                                  <input
                                    #option
                                    matInput
                                    type="text"
                                    [placeholder]="'MENTOREVALUATION.QUESTIONNAIRE.OPTION.title' | translate"
                                  />
                                </mat-form-field>
                              </div>
                              <div class="p-col-4">
                                <button
                                  [disabled]="isPublished"
                                  mat-mini-fab
                                  color="primary"
                                  type="button"
                                  (click)="addMoreAnswers(segmentIndex, questionIndex)"
                                >
                                  <mat-icon>add</mat-icon>
                                </button>
                              </div>
                            </div>

                            <div
                              class="p-grid"
                              [style.display]="checkIsMutiOption(questionField?.value) ? 'flex' : 'none'"
                              *ngIf="questionField.get('answer_type').value !== 'single_option_diploma'"
                            >
                              <div class="p-col-8">
                                <mat-form-field color="accent" style="width: 100%">
                                  <input
                                    #optionInput
                                    matInput
                                    type="text"
                                    [placeholder]="'MENTOREVALUATION.QUESTIONNAIRE.OPTION.title' | translate"
                                    [required]="checkIsMutiOption(questionField?.value) && questionField?.get('options').value.length < 2"
                                  />
                                </mat-form-field>
                              </div>
                              <div class="p-col-4">
                                <button
                                  [disabled]="isPublished || !optionInput.value"
                                  mat-mini-fab
                                  color="primary"
                                  type="button"
                                  type="button"
                                  (click)="addMoreOptions(segmentIndex, questionIndex, optionInput); optionInput.value = ''"
                                >
                                  <mat-icon>add</mat-icon>
                                </button>
                              </div>
                            </div>

                            <div class="p-grid" *ngIf="checkIsMutiOption(questionField?.value)">
                              <ng-container *ngFor="let option of getOptionsFormArrayFrom(questionField).controls; let optionIndex = index">
                                <div class="p-col-12" [formGroup]="option">
                                  <div class="p-grid p-align-center">
                                    <div class="p-col-5">
                                      <span style="text-align: right">{{ optionIndex + 1 }}) {{ option?.value?.option_name }} </span>
                                    </div>
                                    <div class="p-col-1">
                                      <button
                                        [disabled]="isPublished"
                                        type="button"
                                        mat-icon-button
                                        (click)="removeOption(segmentIndex, questionIndex, optionIndex)"
                                        *ngIf="questionField.get('answer_type').value !== 'single_option_diploma'"
                                      >
                                        <mat-icon>delete</mat-icon>
                                      </button>
                                    </div>
                                    <div class="p-col" *ngIf="questionField.get('is_router_on').value">
                                      <mat-form-field color="accent">
                                        <mat-label>{{ 'Go to step' | translate }}</mat-label>
                                        <input
                                          matInput
                                          formControlName="additional_step_name"
                                          [matAutocomplete]="nextStepAuto"
                                          (keyup)="onNextStepType($event)"
                                        />
                                        <mat-autocomplete #nextStepAuto [displayWith]="displayNextStepWithFn.bind(this)">
                                          <mat-option
                                            *ngFor="let option of filteredConditionalStepsDropdown"
                                            [value]="option?.step_title"
                                            (click)="onSelectNextStepAt(optionIndex, questionField, option)"
                                          >
                                            {{ option?.step_title }}
                                          </mat-option>
                                          <mat-option
                                            [value]="'Continue Next Step'"
                                            (click)="onSelectNextStepAt(optionIndex, questionField, 'Continue Next Step')"
                                          >
                                            {{ 'Continue Next Step' | translate }}
                                          </mat-option>
                                          <!-- <mat-option
                                              [value]="'Go To Final Step'"
                                              (click)="onSelectNextStepAt(optionIndex, questionField, 'Go To Final Step')"
                                            >
                                              {{ 'Go To Final Step' | translate }}
                                            </mat-option> -->
                                          <mat-option
                                            [value]="'Go To Final Message'"
                                            (click)="onSelectNextStepAt(optionIndex, questionField, 'Go To Final Message')"
                                          >
                                            {{ 'Go To Final Message' | translate }}
                                          </mat-option>
                                        </mat-autocomplete>
                                        <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                      </mat-form-field>
                                    </div>
                                  </div>
                                </div>
                              </ng-container>
                            </div>
                          </mat-card-content>

                          <!-- if step type campus validadion -->
                          <mat-card-content
                            *ngIf="templateStepForm?.get('step_type').value === 'campus_validation'"
                            [formGroupName]="questionIndex"
                          >
                            <div class="p-grid" formGroupName="special_question">
                              <div class="p-col-12 no-padding-y">
                                <div class="ckeditor">
                                  <ckeditor
                                    formControlName="campus_validation"
                                    #editor
                                    [editor]="Editor"
                                    (ready)="onReady($event)"
                                    [config]="config"
                                    [disabled]="isPublished"
                                  ></ckeditor>
                                </div>
                              </div>
                            </div>
                          </mat-card-content>
                          <!-- if step type campus validadion END  -->

                          <!-- Validation step type special question: document_validate -->
                          <mat-card-content
                            *ngIf="templateStepForm?.get('step_type').value === 'document_to_validate'"
                            [formGroupName]="questionIndex"
                          >
                            <ng-container formGroupName="special_question">
                              <div class="p-col-12" style="padding-top: 0px">
                                <ng-select
                                  formControlName="document_acceptance_type"
                                  [clearable]="false"
                                  appendTo="body"
                                  required
                                  (change)="handleDocumentSelected($event, segmentIndex, questionIndex)"
                                  placeholder="{{ 'Select Document to Validate' | translate }}*"
                                  [disabled]="isPublished"
                                >
                                  <ng-option *ngFor="let type of docListType" [value]="type">{{ type | translate }}</ng-option>
                                </ng-select>
                              </div>

                              <!-- if step_type === document_to_validate and choose text editor -->
                              <div style="width: 99% !important" class="p-col-12 no-padding-y" *ngIf="selectedDocType === 'ck_editor'">
                                <div class="ckeditor">
                                  <ckeditor
                                    #editor
                                    [editor]="Editor"
                                    formControlName="document_acceptance_text"
                                    (ready)="onReady($event)"
                                    [config]="configTypeCondition"
                                    [disabled]="isPublished"
                                  ></ckeditor>
                                </div>
                              </div>

                              <!-- if step_type === document_to_validate and choose upload pdf -->
                              <div class="p-col-12 no-padding-y" *ngIf="selectedDocType === 'upload_pdf'">
                                <ng-container *ngIf="!listUploadDocumentPDF">
                                  <button mat-raised-button color="accent" (click)="openUploadWindow()">
                                    <mat-icon>file_upload</mat-icon> {{ 'Upload PDF for user to accept' | translate }}
                                  </button>
                                  <input
                                    #fileUploadDoc
                                    type="file"
                                    accept=".pdf"
                                    class="hidden"
                                    (change)="chooseFile($event, segmentIndex, questionIndex)"
                                  />
                                </ng-container>
                                <div class="p-grid" *ngIf="listUploadDocumentPDF" style="padding-top: 15px">
                                  <input
                                    #fileUploadDoc
                                    type="file"
                                    accept=".pdf"
                                    class="hidden"
                                    (change)="chooseFile($event, segmentIndex, questionIndex)"
                                  />
                                  <div class="p-col-2">
                                    <button (click)="openUploadWindow()" mat-icon-button matTooltip="{{ 'Edit' | translate }}">
                                      <mat-icon style="color: black">edit</mat-icon>
                                    </button>
                                    <button (click)="deletePDF()" mat-icon-button matTooltip="{{ 'Delete' | translate }}">
                                      <mat-icon style="color: black">delete</mat-icon>
                                    </button>
                                  </div>
                                  <div class="p-col-10" style="margin-top: 6px">
                                    {{ listUploadDocumentPDF }}
                                  </div>
                                </div>
                              </div>

                              <!-- if step_type === document_to_validate and choose from builder -->
                              <ng-container *ngIf="selectedDocType === 'doc_builder'">
                                <div class="p-col-12 no-padding-y">
                                  <ng-select
                                    formControlName="document_builder_id"
                                    [clearable]="false"
                                    appendTo="body"
                                    [required]="selectedDocType === 'doc_builder'"
                                    placeholder="{{ 'Select Document from Document Builder' | translate }}*"
                                    [disabled]="isPublished"
                                  >
                                    <ng-option *ngFor="let doc of documentBuilders" [value]="doc._id">{{
                                      doc.document_builder_name
                                    }}</ng-option>
                                  </ng-select>
                                </div>
                              </ng-container>
                            </ng-container>
                          </mat-card-content>
                          <!-- Validation step type special question: document_validate end -->

                          <!-- if step type step_summary -->
                          <mat-card-content
                            *ngIf="templateStepForm?.get('step_type').value === 'step_summary'"
                            [formGroupName]="questionIndex"
                          >
                            <div class="p-grid" formGroupName="special_question">
                              <div class="p-col-12 no-padding-y">
                                <!-- Header -->
                                <div class="p-grid">
                                  <div class="p-col-6">
                                    <label>{{ 'FORM_BUILDER.Header of the summary' | translate }}</label>
                                  </div>
                                </div>
                                <div class="p-col-12 no-padding-y">
                                  <div class="ckeditor">
                                    <!-- [formControl]="questions.controls['question_label']" -->
                                    <ckeditor
                                      formControlName="summary_header"
                                      #editor
                                      [editor]="Editor"
                                      (ready)="onReady($event)"
                                      [config]="config"
                                      [disabled]="isPublished"
                                    ></ckeditor>
                                  </div>
                                </div>
                                <!-- Footer -->
                                <div class="p-grid">
                                  <div class="p-col-6">
                                    <label>{{ 'FORM_BUILDER.Footer of the summary' | translate }}</label>
                                  </div>
                                </div>
                                <div class="p-col-12 no-padding-y">
                                  <div class="ckeditor">
                                    <!-- [formControl]="questions.controls['question_label']" -->
                                    <ckeditor
                                      formControlName="summary_footer"
                                      #editor
                                      [editor]="Editor"
                                      (ready)="onReady($event)"
                                      [config]="config"
                                      [disabled]="isPublished"
                                    ></ckeditor>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </mat-card-content>
                          <!-- if step type step_summary END  -->

                          <!-- if step type final_message -->
                          <mat-card-content
                            *ngIf="templateStepForm?.get('step_type').value === 'final_message'"
                            [formGroupName]="questionIndex"
                          >
                            <div class="p-grid" formGroupName="final_message_question">
                              <div class="p-col-12 no-padding-y">
                                <!-- Header -->
                                <div class="p-grid">
                                  <div class="p-col-6">
                                    <label>{{ 'Header of the summary' | translate }}</label>
                                  </div>
                                </div>
                                <div class="p-col-12 no-padding-y">
                                  <div class="ckeditor">
                                    <!-- [formControl]="questions.controls['question_label']" -->
                                    <ckeditor
                                      formControlName="final_message_summary_header"
                                      #editor
                                      [editor]="Editor"
                                      (ready)="onReady($event)"
                                      [config]="config"
                                      [disabled]="isPublished"
                                    ></ckeditor>
                                  </div>
                                </div>
                                <!-- Footer -->
                                <div class="p-grid">
                                  <div class="p-col-6">
                                    <label>{{ 'Footer of the summary' | translate }}</label>
                                  </div>
                                </div>
                                <div class="p-col-12 no-padding-y">
                                  <div class="ckeditor">
                                    <!-- [formControl]="questions.controls['question_label']" -->
                                    <ckeditor
                                      formControlName="final_message_summary_footer"
                                      #editor
                                      [editor]="Editor"
                                      (ready)="onReady($event)"
                                      [config]="config"
                                      [disabled]="isPublished"
                                    ></ckeditor>
                                  </div>
                                </div>

                                <div class="p-grid">
                                  <div class="p-col-6">
                                    <label>{{ 'Image' | translate }}</label> <br />
                                    <button mat-raised-button color="accent" (click)="image.click()" [disabled]="isPublished">
                                      <mat-icon class="mat-icon-default">add</mat-icon>
                                      {{ 'Select File' | translate }}
                                    </button>
                                    <br />
                                    <input
                                      #image
                                      type="file"
                                      accept=".jpeg, .jpg, .png"
                                      hidden
                                      [disabled]="isPublished"
                                      (change)="chooseImageFinalMessage($event, segmentIndex, questionIndex); image.value = ''"
                                    />
                                    <img
                                      src="{{ serverimgPath }}{{
                                        questionField.get('final_message_question').get('final_message_image').get('s3_file_name').value
                                      }}"
                                      *ngIf="
                                        questionField.get('final_message_question').get('final_message_image').get('s3_file_name').value
                                      "
                                      maxWidth="300px"
                                    />
                                    <br />
                                    <button
                                      *ngIf="
                                        questionField.get('final_message_question').get('final_message_image').get('s3_file_name').value
                                      "
                                      (click)="removeImage(segmentIndex, questionIndex)"
                                      mat-icon-button
                                      class="small-icon"
                                      color="red"
                                      [disabled]="isPublished"
                                    >
                                      <mat-icon>remove</mat-icon>
                                    </button>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </mat-card-content>
                          <!-- if step type final_message END  -->
                        </div>
                      </mat-card>
                    </div>
                  </div>

                  <div class="p-col-12">
                    <!-- with Form Control -->

                    <mat-slide-toggle formControlName="is_multiple_financial_support">
                      {{ 'Multiple Financial Supports' | translate }}
                    </mat-slide-toggle>

                    <!-- No Formcontrol -->
                    <!-- <mat-slide-toggle>{{ 'Multiple Financial Supports' | translate }}</mat-slide-toggle> -->
                  </div>
                </ng-container>

                <!-- Document type for certification acceptance is only for step condition acceptance -->
                <!-- <ng-container *ngIf="templateStepForm?.get('step_type').value !== 'document_validation'">
                  <div class="p-col-12" style="padding-top: 0px">
                    <ng-select
                      formControlName="document_for_condition"
                      [clearable]="false"
                      appendTo="body"
                      required
                      (change)="handleDocumentSelected($event, segmentIndex)"
                      placeholder="{{ 'Document for condition' | translate }}*"
                      [disabled]="isPublished"
                    >
                      <ng-option *ngFor="let type of docListType" [value]="type">{{ type | translate }}</ng-option>
                    </ng-select>
                  </div>

                  <div style="width: 99% !important" class="p-col-12 no-padding-y" *ngIf="selectedDocType === 'ck_editor'">
                    <div class="ckeditor">
                      <ckeditor
                        #editor
                        [editor]="Editor"
                        formControlName="acceptance_text"
                        (ready)="onReady($event)"
                        [config]="configTypeCondition"
                        [disabled]="isPublished"
                      ></ckeditor>
                    </div>
                  </div>

                  <div class="p-col-12 no-padding-y" *ngIf="selectedDocType === 'upload_pdf'">
                    <ng-container *ngIf="!listUploadDocumentPDF">
                      <button mat-raised-button color="accent" (click)="openUploadWindow()" [disabled]="isPublished">
                        <mat-icon>file_upload</mat-icon> {{ 'Upload PDF for user to accept' | translate }}
                      </button>
                      <input #fileUploadDoc type="file" accept=".pdf" class="hidden" (change)="chooseFile($event, segmentIndex)" />
                    </ng-container>
                    <div class="p-grid" *ngIf="listUploadDocumentPDF" style="padding-top: 15px">
                      <input #fileUploadDoc type="file" accept=".pdf" class="hidden" (change)="chooseFile($event, segmentIndex)" />
                      <div class="p-col-2">
                        <button [disabled]="isPublished" (click)="openUploadWindow()" mat-icon-button matTooltip="{{ 'Edit' | translate }}">
                          <mat-icon style="color: black">edit</mat-icon>
                        </button>
                        <button [disabled]="isPublished" (click)="deletePDF()" mat-icon-button matTooltip="{{ 'Delete' | translate }}">
                          <mat-icon style="color: black">delete</mat-icon>
                        </button>
                      </div>
                      <div class="p-col-10" style="margin-top: 6px">
                        {{ listUploadDocumentPDF }}
                      </div>
                    </div>
                  </div>
                </ng-container> -->

                <!-- Add Question does not exist in step condition acceptance -->
                <ng-container
                  *ngIf="
                    templateStepForm?.get('step_type').value === 'condition_acceptance' ||
                      templateStepForm?.get('step_type').value === 'campus_validation' ||
                      templateStepForm?.get('step_type').value === 'step_summary' ||
                      templateStepForm?.get('step_type').value === 'down_payment_mode' ||
                      templateStepForm?.get('step_type').value === 'finance' ||
                      templateStepForm?.get('step_type').value === 'document_to_validate' ||
                      templateStepForm?.get('step_type').value === 'final_message';
                    else addQuestion
                  "
                ></ng-container>
                <ng-template #addQuestion>
                  <div class="p-col-12 text-end-no-pad-r">
                    <button
                      matTooltip="{{ 'FORM_BUILDER.Add Question' | translate }}"
                      mat-raised-button
                      color="accent"
                      (click)="addQuestionFieldForm(segmentIndex, 'financial_support'); scrollIntoLastQuestion(segmentIndex)"
                    >
                      {{ 'FORM_BUILDER.Add Question' | translate }}
                    </button>
                  </div>
                </ng-template>
              </div>

              <div class="p-grid">
                <div
                  class="p-col-12 no-padding"
                  formArrayName="questions"
                  [cdkDropListData]="getQuestionFieldFormArray(segmentIndex).controls"
                  cdkDropList
                  (cdkDropListDropped)="dropQuestion($event, segmentIndex)"
                >
                  <div *ngFor="let questionField of getQuestionFieldFormArray(segmentIndex).controls; let questionIndex = index">
                    <mat-card
                      *ngIf="questionField?.get('modality_question_type')?.value !== 'student'"
                      class="mrgn-all-xs"
                      cdkDrag
                      [cdkDragDisabled]="
                        isPublished ||
                        templateStepForm?.get('step_type').value === 'campus_validation' ||
                        templateStepForm?.get('step_type').value === 'step_summary'
                      "
                    >
                      <div #questionPanel>
                        <!-- QUESTION TYPE: EXPECTED DOCUMENT AND FIELD BELOW ----------------------------------------------------------------------------------------------------->
                        <mat-card-content
                          *ngIf="templateStepForm?.get('step_type').value === 'document_expected'"
                          [formGroupName]="questionIndex"
                          cdkDragHandle
                        >
                          <div class="p-grid">
                            <!-- The toggles row -->
                            <div class="p-col-10" style="align-self: center; padding-bottom: 0px">
                              <!-- this slide hide for temporary; EDH can use it in the future -->
                              <!-- <mat-slide-toggle
                                [disabled]="isPublished"
                                formControlName="is_field"
                                (change)="updateFieldToggle($event, segmentIndex, questionIndex)"
                              >
                                <span [ngClass]="{ 'text-slider-color': questionField?.get('is_field').value }">
                                  {{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD' | translate }}
                                </span>
                              </mat-slide-toggle> -->
                              <mat-slide-toggle formControlName="is_required" [disabled]="isPublished" style="margin-left: 1rem">
                                <span [ngClass]="{ 'text-slider-color': questionField?.get('is_required').value }">
                                  {{
                                    (questionField?.get('is_required').value ? 'FORM_BUILDER.Required' : 'FORM_BUILDER.Not Required')
                                      | translate
                                  }}
                                </span>
                              </mat-slide-toggle>
                            </div>
                            <div class="p-col-2" style="padding-bottom: 0px">
                              <div style="text-align: right">
                                <button
                                  (click)="removeQuestionFieldForm(segmentIndex, questionIndex)"
                                  mat-icon-button
                                  class="small-icon"
                                  color="red"
                                >
                                  <mat-icon>remove</mat-icon>
                                </button>
                              </div>
                            </div>
                          </div>

                          <div class="p-grid">
                            <div class="p-col-8">
                              <ng-select
                                placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.ANSWER_TYPE' | translate }}"
                                formControlName="answer_type"
                                [clearable]="false"
                                appendTo="body"
                                required
                                [disabled]="isPublished"
                              >
                                <ng-option
                                  *ngFor="let questionAnswerType of questionnaireConsts?.expectedDocumentTypes"
                                  [value]="questionAnswerType.value"
                                  >{{ 'EXPECTED_DOCUMENT_TYPES.' + questionAnswerType.view | translate }}</ng-option
                                >
                              </ng-select>
                            </div>
                          </div>

                          <!-- Second row, question label, only if non-field -->
                          <div class="p-grid">
                            <div [style.display]="questionField?.get('is_field').value ? 'block' : 'none'" class="p-col-4">
                              <ng-select
                                placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_TYPE' | translate }}"
                                formControlName="field_type"
                                [clearable]="false"
                                appendTo="body"
                                [required]="questionField?.get('is_field').value"
                                [disabled]="isPublished"
                                (change)="selectDocumentExpectedType($event, segmentIndex, questionIndex)"
                              >
                                <ng-option
                                  [disabled]="isPublished"
                                  *ngFor="let field of questionnaireConsts?.documentExpectedFields"
                                  [value]="field"
                                  >{{ 'FORM_BUILDER_FIELD.' + field | translate }}</ng-option
                                >
                              </ng-select>
                            </div>
                            <div [style.display]="!questionField?.get('is_field').value ? 'block' : 'none'" class="p-col-12 custom-css">
                              <mat-form-field>
                                <input
                                  required
                                  matInput
                                  formControlName="question_label"
                                  [placeholder]="'Question Label' | translate"
                                  type="text"
                                />
                              </mat-form-field>
                            </div>
                          </div>
                        </mat-card-content>

                        <!-- QUESTION TYPE: NORMAL QUESTION AND FIELD BELOW ----------------------------------------------------------------------------------------------------->
                        <mat-card-content
                          *ngIf="
                            templateStepForm?.get('step_type').value === 'question_and_field' ||
                            templateStepForm?.get('step_type').value === 'modality_payment' ||
                            templateStepForm?.get('step_type').value === 'academic_journey' ||
                            templateStepForm?.get('step_type').value === 'document_to_validate'
                          "
                          [formGroupName]="questionIndex"
                          cdkDragHandle
                        >
                          <div class="p-grid">
                            <ng-container *ngIf="templateStepForm?.get('step_type').value !== 'document_to_validate'">
                              <div class="p-col-10" style="align-self: center; padding-bottom: 0px">
                                <mat-slide-toggle
                                  [disabled]="isPublished"
                                  formControlName="is_field"
                                  (change)="updateFieldToggle($event, segmentIndex, questionIndex)"
                                >
                                  <span [ngClass]="{ 'text-slider-color': questionField?.get('is_field').value }">
                                    {{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD' | translate }}
                                  </span>
                                </mat-slide-toggle>
                                <mat-slide-toggle
                                  *ngIf="questionField?.get('is_field').value"
                                  style="margin-left: 1rem"
                                  formControlName="is_editable"
                                  (change)="updateEditableToggle($event, segmentIndex, questionIndex)"
                                  [disabled]="isPublished || checkFieldType(questionField.get('field_type').value)"
                                >
                                  <span [ngClass]="{ 'text-slider-color': questionField?.get('is_editable').value }">
                                    {{
                                      (questionField?.get('is_editable').value ? 'FORM_BUILDER.Editable' : 'FORM_BUILDER.Not Editable')
                                        | translate
                                    }}
                                  </span>
                                </mat-slide-toggle>
                                <mat-slide-toggle
                                  *ngIf="questionField?.get('is_editable').value"
                                  style="margin-left: 1rem"
                                  formControlName="is_required"
                                  [disabled]="isPublished"
                                >
                                  <span [ngClass]="{ 'text-slider-color': questionField?.get('is_required').value }">
                                    {{
                                      (questionField?.get('is_required').value ? 'FORM_BUILDER.Required' : 'FORM_BUILDER.Not Required')
                                        | translate
                                    }}
                                  </span>
                                </mat-slide-toggle>
                              </div>
                              <div class="p-col-2" style="padding-bottom: 0px">
                                <div style="text-align: right">
                                  <button
                                    (click)="removeQuestionFieldForm(segmentIndex, questionIndex)"
                                    mat-icon-button
                                    class="small-icon"
                                    color="red"
                                  >
                                    <mat-icon>remove</mat-icon>
                                  </button>
                                </div>
                              </div>
                            </ng-container>
                          </div>

                          <div class="p-grid">
                            <!-- Display the answer type if field is false -->
                            <ng-container *ngIf="templateStepForm?.get('step_type').value !== 'document_to_validate'">
                              <div [style.display]="!questionField.get('is_field').value ? 'block' : 'none'" class="p-col-4">
                                <mat-form-field>
                                  <input
                                    matInput
                                    formControlName="ref_id"
                                    [placeholder]="'ERP_009_TEACHER_CONTRACT.Ref Id' | translate"
                                    type="text"
                                    [required]="!questionField.get('is_field').value"
                                  />
                                </mat-form-field>
                              </div>
                              <div [style.display]="!questionField.get('is_field').value ? 'block' : 'none'" class="p-col-4">
                                <ng-select
                                  class="dropdown"
                                  placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.ANSWER_TYPE' | translate }}"
                                  formControlName="answer_type"
                                  [clearable]="false"
                                  appendTo="body"
                                  [required]="!questionField.get('is_field').value"
                                  (change)="checkAnswerType(segmentIndex, questionIndex)"
                                >
                                  <ng-container *ngIf="templateType === 'admission_document'">
                                    <ng-option
                                      *ngFor="let questionAnswerType of questionnaireConsts.questionAnswerTypesAdmissionDocument"
                                      [value]="questionAnswerType.key"
                                      >{{ 'QUESTION_ANSWER_TYPE.' + questionAnswerType.name.toUpperCase() | translate }}</ng-option
                                    >
                                  </ng-container>
                                  <ng-container *ngIf="templateType !== 'admission_document'">
                                    <ng-option
                                      *ngFor="let questionAnswerType of questionnaireConsts.questionAnswerTypes"
                                      [value]="questionAnswerType.key"
                                      >{{ 'QUESTION_ANSWER_TYPE.' + questionAnswerType.name.toUpperCase() | translate }}</ng-option
                                    >
                                  </ng-container>
                                </ng-select>
                              </div>
                            </ng-container>

                            <!-- Display the field dropdown if field is true -->
                            <ng-container *ngIf="templateStepForm?.get('step_type').value !== 'document_to_validate'">
                              <div [style.display]="questionField?.get('is_field').value ? 'block' : 'none'" class="p-col-4">
                                <!-- <ng-select
                                  *ngIf="
                                    templateStepForm?.get('step_type').value !== 'modality_payment' ||
                                    templateStepForm?.get('step_type').value !== 'question_and_field'
                                  "
                                  placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_TYPE' | translate }}"
                                  formControlName="field_type"
                                  [clearable]="false"
                                  appendTo="body"
                                  [required]="questionField?.get('is_field').value"
                                  [disabled]="isPublished"
                                >
                                  <ng-option
                                    [disabled]="isPublished"
                                    *ngFor="let field of questionnaireConsts?.questionnaireFields"
                                    [value]="field"
                                    >{{ 'FORM_BUILDER_FIELD.' + field | translate }}</ng-option
                                  >
                                </ng-select> -->

                                <!-- this field type for question_and_field type -->
                                <ng-select
                                  *ngIf="templateStepForm?.get('step_type').value === 'question_and_field'"
                                  placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_TYPE' | translate }}*"
                                  formControlName="field_type"
                                  [clearable]="false"
                                  appendTo="body"
                                  [required]="questionField?.get('is_field').value"
                                  [disabled]="isPublished"
                                >
                                  <!-- *ngFor="let field of questionnaireConsts?.questionAndFieldType" -->

                                  <ng-container *ngIf="templateType === 'alumni'">
                                    <ng-option
                                      [disabled]="isPublished"
                                      *ngFor="let field of questionnaireConsts?.questionnaireFieldsForAlumni"
                                      [value]="field"
                                    >
                                      {{ 'FORM_BUILDER_FIELD.' + field | translate }}
                                    </ng-option>
                                  </ng-container>

                                  <ng-container *ngIf="templateType === 'teacher_contract'">
                                    <ng-option
                                      [disabled]="isPublished"
                                      *ngFor="let field of questionnaireConsts?.questionnaireFieldsForTeacher"
                                      [value]="field"
                                    >
                                      {{ 'FORM_BUILDER_FIELD.' + field | translate }}
                                    </ng-option>
                                  </ng-container>

                                  <ng-container *ngIf="templateType === 'fc_contract'">
                                    <ng-option
                                      [disabled]="isPublished"
                                      *ngFor="let field of questionnaireConsts?.questionnaireFieldsForContract"
                                      [value]="field"
                                    >
                                      {{ 'FORM_BUILDER_FIELD.' + field | translate }}
                                    </ng-option>
                                  </ng-container>

                                  <ng-container *ngIf="templateType === 'student_admission'">
                                    <ng-option
                                      [disabled]="isPublished"
                                      *ngFor="let field of questionnaireConsts?.questionAndFieldType"
                                      [value]="field"
                                    >
                                      {{ 'FORM_BUILDER_FIELD.' + field | translate }}
                                    </ng-option>
                                  </ng-container>

                                  <!-- Field Admission Document -->
                                  <ng-container *ngIf="templateType === 'admission_document'">
                                    <ng-option
                                      [disabled]="isPublished"
                                      *ngFor="let field of questionnaireConsts?.questionAndFieldAdmissionDocumentType"
                                      [value]="field"
                                    >
                                      {{ 'FORM_BUILDER_FIELD.' + field | translate }}
                                    </ng-option>
                                  </ng-container>
                                </ng-select>

                                <!-- this field type for modality_payment type -->
                                <ng-select
                                  *ngIf="templateStepForm?.get('step_type').value === 'modality_payment'"
                                  placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_TYPE' | translate }}"
                                  formControlName="field_type"
                                  [clearable]="false"
                                  appendTo="body"
                                  [required]="questionField?.get('is_field').value"
                                  [disabled]="isPublished"
                                >
                                  <ng-option
                                    [disabled]="isPublished"
                                    *ngFor="let field of questionnaireConsts?.modalityPaymentFieldType"
                                    [value]="field"
                                    >{{ '031_FORMBUILDER_MODALITYPAYMENT_FIELD.' + field | translate }}</ng-option
                                  >
                                </ng-select>
                              </div>
                            </ng-container>

                            <!-- Always display the position regardless field true/false -->
                            <ng-container *ngIf="templateStepForm?.get('step_type').value !== 'document_to_validate'">
                              <div class="p-col-4">
                                <ng-select
                                  placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_POSITION' | translate }}*"
                                  formControlName="field_position"
                                  [clearable]="false"
                                  appendTo="body"
                                  required
                                  [disabled]="isPublished"
                                >
                                  <ng-option *ngFor="let position of questionnaireConsts?.questionPositions" [value]="position">{{
                                    'FORM_BUILDER.POSITION.' + position | translate
                                  }}</ng-option>
                                </ng-select>
                              </div>
                            </ng-container>

                            <!-- For Question Name, only displayed if field false -->
                            <ng-container *ngIf="templateStepForm?.get('step_type').value !== 'document_to_validate'">
                              <div
                                [style.display]="
                                  !questionField.get('is_field').value &&
                                  ['single_option', 'single_option_diploma'].includes(questionField.get('answer_type').value)
                                    ? 'contents'
                                    : 'none'
                                "
                              >
                                <div class="p-col-12">
                                  <mat-slide-toggle formControlName="is_router_on">
                                    {{ questionField.get('is_router_on').value ? ('Router ON' | translate) : ('Router OFF' | translate) }}
                                  </mat-slide-toggle>
                                </div>
                              </div>

                              <div [style.display]="!questionField?.get('is_field').value ? 'block' : 'none'" class="p-col-12">
                                <mat-form-field>
                                  <input
                                    matInput
                                    formControlName="question_label"
                                    [placeholder]="'Question Label' | translate"
                                    type="text"
                                    [required]="!questionField?.get('is_field').value"
                                  />
                                </mat-form-field>
                              </div>
                            </ng-container>
                          </div>

                          <div
                            fxLayout="row"
                            *ngIf="
                              questionField &&
                              checkIsParentChild(questionField.value) &&
                              templateStepForm?.get('step_type').value !== 'document_to_validate'
                            "
                          >
                            <div class="p-col-8">
                              <mat-form-field color="accent">
                                <input
                                  #option
                                  matInput
                                  type="text"
                                  [placeholder]="'MENTOREVALUATION.QUESTIONNAIRE.OPTION.title' | translate"
                                />
                              </mat-form-field>
                            </div>
                            <div class="p-col-4">
                              <button
                                [disabled]="isPublished"
                                mat-mini-fab
                                color="primary"
                                type="button"
                                (click)="addMoreAnswers(segmentIndex, questionIndex)"
                              >
                                <mat-icon>add</mat-icon>
                              </button>
                            </div>
                          </div>

                          <div
                            class="p-grid"
                            [style.display]="checkIsMutiOption(questionField?.value) ? 'flex' : 'none'"
                            *ngIf="questionField.get('answer_type').value !== 'single_option_diploma'"
                          >
                            <div class="p-col-8">
                              <mat-form-field color="accent" style="width: 100%">
                                <input
                                  #optionInput
                                  matInput
                                  type="text"
                                  [placeholder]="'MENTOREVALUATION.QUESTIONNAIRE.OPTION.title' | translate"
                                  [required]="checkIsMutiOption(questionField?.value) && questionField?.get('options').value.length < 2"
                                />
                              </mat-form-field>
                            </div>
                            <div class="p-col-4">
                              <button
                                [disabled]="isPublished || !optionInput.value"
                                mat-mini-fab
                                color="primary"
                                type="button"
                                type="button"
                                (click)="addMoreOptions(segmentIndex, questionIndex, optionInput); optionInput.value = ''"
                              >
                                <mat-icon>add</mat-icon>
                              </button>
                            </div>
                          </div>

                          <div class="p-grid" *ngIf="checkIsMutiOption(questionField?.value)">
                            <ng-container *ngFor="let option of getOptionsFormArrayFrom(questionField).controls; let optionIndex = index">
                              <div class="p-col-12" [formGroup]="option">
                                <div class="p-grid p-align-center">
                                  <div class="p-col-5">
                                    <span style="text-align: right">{{ optionIndex + 1 }}) {{ option?.value?.option_name }} </span>
                                  </div>
                                  <div class="p-col-1">
                                    <button
                                      [disabled]="isPublished"
                                      type="button"
                                      mat-icon-button
                                      (click)="removeOption(segmentIndex, questionIndex, optionIndex)"
                                      *ngIf="questionField.get('answer_type').value !== 'single_option_diploma'"
                                    >
                                      <mat-icon>delete</mat-icon>
                                    </button>
                                  </div>
                                  <div class="p-col" *ngIf="questionField.get('is_router_on').value">
                                    <mat-form-field color="accent">
                                      <mat-label>{{ 'Go to step' | translate }}</mat-label>
                                      <input
                                        matInput
                                        formControlName="additional_step_name"
                                        [matAutocomplete]="nextStepAuto"
                                        (keyup)="onNextStepType($event)"
                                      />
                                      <mat-autocomplete #nextStepAuto [displayWith]="displayNextStepWithFn.bind(this)">
                                        <mat-option
                                          *ngFor="let option of filteredConditionalStepsDropdown"
                                          [value]="option?.step_title"
                                          (click)="onSelectNextStepAt(optionIndex, questionField, option)"
                                        >
                                          {{ option?.step_title }}
                                        </mat-option>
                                        <mat-option
                                          [value]="'Continue Next Step'"
                                          (click)="onSelectNextStepAt(optionIndex, questionField, 'Continue Next Step')"
                                        >
                                          {{ 'Continue Next Step' | translate }}
                                        </mat-option>
                                        <!-- <mat-option
                                          [value]="'Go To Final Step'"
                                          (click)="onSelectNextStepAt(optionIndex, questionField, 'Go To Final Step')"
                                        >
                                          {{ 'Go To Final Step' | translate }}
                                        </mat-option> -->
                                        <mat-option
                                          [value]="'Go To Final Message'"
                                          (click)="onSelectNextStepAt(optionIndex, questionField, 'Go To Final Message')"
                                        >
                                          {{ 'Go To Final Message' | translate }}
                                        </mat-option>
                                      </mat-autocomplete>
                                      <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                    </mat-form-field>
                                  </div>
                                </div>
                              </div>
                            </ng-container>
                          </div>
                        </mat-card-content>

                        <!-- if step type campus validadion -->
                        <mat-card-content
                          *ngIf="templateStepForm?.get('step_type').value === 'campus_validation'"
                          [formGroupName]="questionIndex"
                        >
                          <div class="p-grid" formGroupName="special_question">
                            <div class="p-col-12 no-padding-y">
                              <div class="ckeditor">
                                <ckeditor
                                  formControlName="campus_validation"
                                  #editor
                                  [editor]="Editor"
                                  (ready)="onReady($event)"
                                  [config]="config"
                                  [disabled]="isPublished"
                                ></ckeditor>
                              </div>
                            </div>
                          </div>
                        </mat-card-content>
                        <!-- if step type campus validadion END  -->

                        <!-- Validation step type special question: document_validate -->
                        <mat-card-content
                          *ngIf="templateStepForm?.get('step_type').value === 'document_to_validate'"
                          [formGroupName]="questionIndex"
                        >
                          <ng-container formGroupName="special_question">
                            <div class="p-col-12" style="padding-top: 0px">
                              <ng-select
                                formControlName="document_acceptance_type"
                                [clearable]="false"
                                appendTo="body"
                                required
                                (change)="handleDocumentSelected($event, segmentIndex, questionIndex)"
                                placeholder="{{ 'Select Document to Validate' | translate }}*"
                                [disabled]="isPublished"
                              >
                                <ng-option *ngFor="let type of docListType" [value]="type">{{ type | translate }}</ng-option>
                              </ng-select>
                            </div>

                            <!-- if step_type === document_to_validate and choose text editor -->
                            <div style="width: 99% !important" class="p-col-12 no-padding-y" *ngIf="selectedDocType === 'ck_editor'">
                              <div class="ckeditor">
                                <ckeditor
                                  #editor
                                  [editor]="Editor"
                                  formControlName="document_acceptance_text"
                                  (ready)="onReady($event)"
                                  [config]="configTypeCondition"
                                  [disabled]="isPublished"
                                ></ckeditor>
                              </div>
                            </div>

                            <!-- if step_type === document_to_validate and choose upload pdf -->
                            <div class="p-col-12 no-padding-y" *ngIf="selectedDocType === 'upload_pdf'">
                              <ng-container *ngIf="!listUploadDocumentPDF">
                                <button mat-raised-button color="accent" (click)="openUploadWindow()">
                                  <mat-icon>file_upload</mat-icon> {{ 'Upload PDF for user to accept' | translate }}
                                </button>
                                <input
                                  #fileUploadDoc
                                  type="file"
                                  accept=".pdf"
                                  class="hidden"
                                  (change)="chooseFile($event, segmentIndex, questionIndex)"
                                />
                              </ng-container>
                              <div class="p-grid" *ngIf="listUploadDocumentPDF" style="padding-top: 15px">
                                <input
                                  #fileUploadDoc
                                  type="file"
                                  accept=".pdf"
                                  class="hidden"
                                  (change)="chooseFile($event, segmentIndex, questionIndex)"
                                />
                                <div class="p-col-2">
                                  <button (click)="openUploadWindow()" mat-icon-button matTooltip="{{ 'Edit' | translate }}">
                                    <mat-icon style="color: black">edit</mat-icon>
                                  </button>
                                  <button (click)="deletePDF()" mat-icon-button matTooltip="{{ 'Delete' | translate }}">
                                    <mat-icon style="color: black">delete</mat-icon>
                                  </button>
                                </div>
                                <div class="p-col-10" style="margin-top: 6px">
                                  {{ listUploadDocumentPDF }}
                                </div>
                              </div>
                            </div>

                            <!-- if step_type === document_to_validate and choose from builder -->
                            <ng-container *ngIf="selectedDocType === 'doc_builder'">
                              <div class="p-col-12 no-padding-y">
                                <ng-select
                                  formControlName="document_builder_id"
                                  [clearable]="false"
                                  appendTo="body"
                                  [required]="selectedDocType === 'doc_builder'"
                                  placeholder="{{ 'Select Document from Document Builder' | translate }}*"
                                  [disabled]="isPublished"
                                >
                                  <ng-option *ngFor="let doc of documentBuilders" [value]="doc._id">{{
                                    doc.document_builder_name
                                  }}</ng-option>
                                </ng-select>
                              </div>
                            </ng-container>
                          </ng-container>
                        </mat-card-content>
                        <!-- Validation step type special question: document_validate end -->

                        <!-- if step type step_summary -->
                        <mat-card-content
                          *ngIf="templateStepForm?.get('step_type').value === 'step_summary'"
                          [formGroupName]="questionIndex"
                        >
                          <div class="p-grid" formGroupName="special_question">
                            <div class="p-col-12 no-padding-y">
                              <!-- Header -->
                              <div class="p-grid">
                                <div class="p-col-6">
                                  <label>{{ 'FORM_BUILDER.Header of the summary' | translate }}</label>
                                </div>
                              </div>
                              <div class="p-col-12 no-padding-y">
                                <div class="ckeditor">
                                  <!-- [formControl]="questions.controls['question_label']" -->
                                  <ckeditor
                                    formControlName="summary_header"
                                    #editor
                                    [editor]="Editor"
                                    (ready)="onReady($event)"
                                    [config]="config"
                                    [disabled]="isPublished"
                                  ></ckeditor>
                                </div>
                              </div>
                              <!-- Footer -->
                              <div class="p-grid">
                                <div class="p-col-6">
                                  <label>{{ 'FORM_BUILDER.Footer of the summary' | translate }}</label>
                                </div>
                              </div>
                              <div class="p-col-12 no-padding-y">
                                <div class="ckeditor">
                                  <!-- [formControl]="questions.controls['question_label']" -->
                                  <ckeditor
                                    formControlName="summary_footer"
                                    #editor
                                    [editor]="Editor"
                                    (ready)="onReady($event)"
                                    [config]="config"
                                    [disabled]="isPublished"
                                  ></ckeditor>
                                </div>
                              </div>
                            </div>
                          </div>
                        </mat-card-content>
                        <!-- if step type step_summary END  -->

                        <!-- if step type final_message -->
                        <mat-card-content
                          *ngIf="templateStepForm?.get('step_type').value === 'final_message'"
                          [formGroupName]="questionIndex"
                        >
                          <div class="p-grid" formGroupName="final_message_question">
                            <div class="p-col-12 no-padding-y">
                              <!-- Header -->
                              <div class="p-grid">
                                <div class="p-col-6">
                                  <label>{{ 'Header of the summary' | translate }}</label>
                                </div>
                              </div>
                              <div class="p-col-12 no-padding-y">
                                <div class="ckeditor">
                                  <!-- [formControl]="questions.controls['question_label']" -->
                                  <ckeditor
                                    formControlName="final_message_summary_header"
                                    #editor
                                    [editor]="Editor"
                                    (ready)="onReady($event)"
                                    [config]="config"
                                    [disabled]="isPublished"
                                  ></ckeditor>
                                </div>
                              </div>
                              <!-- Footer -->
                              <div class="p-grid">
                                <div class="p-col-6">
                                  <label>{{ 'Footer of the summary' | translate }}</label>
                                </div>
                              </div>
                              <div class="p-col-12 no-padding-y">
                                <div class="ckeditor">
                                  <!-- [formControl]="questions.controls['question_label']" -->
                                  <ckeditor
                                    formControlName="final_message_summary_footer"
                                    #editor
                                    [editor]="Editor"
                                    (ready)="onReady($event)"
                                    [config]="config"
                                    [disabled]="isPublished"
                                  ></ckeditor>
                                </div>
                              </div>

                              <div class="p-grid">
                                <div class="p-col-6">
                                  <label>{{ 'Image' | translate }}</label> <br />
                                  <button mat-raised-button color="accent" (click)="image.click()" [disabled]="isPublished">
                                    <mat-icon class="mat-icon-default">add</mat-icon>
                                    {{ 'Select File' | translate }}
                                  </button>
                                  <br />
                                  <input
                                    #image
                                    type="file"
                                    accept=".jpeg, .jpg, .png"
                                    hidden
                                    [disabled]="isPublished"
                                    (change)="chooseImageFinalMessage($event, segmentIndex, questionIndex); image.value = ''"
                                  />
                                  <img
                                    src="{{ serverimgPath }}{{
                                      questionField.get('final_message_question').get('final_message_image').get('s3_file_name').value
                                    }}"
                                    *ngIf="questionField.get('final_message_question').get('final_message_image').get('s3_file_name').value"
                                    maxWidth="300px"
                                  />
                                  <br />
                                  <button
                                    *ngIf="questionField.get('final_message_question').get('final_message_image').get('s3_file_name').value"
                                    (click)="removeImage(segmentIndex, questionIndex)"
                                    mat-icon-button
                                    class="small-icon"
                                    color="red"
                                    [disabled]="isPublished"
                                  >
                                    <mat-icon>remove</mat-icon>
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </mat-card-content>
                        <!-- if step type final_message END  -->
                      </div>
                    </mat-card>
                  </div>
                </div>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </div>
      </div>
    </fieldset>
  </div>

  <div class="p-col-6 preview-side preview-side" style="padding-left: 1rem" *ngIf="templateStepForm?.get('step_type').value">
    <mat-horizontal-stepper #stepperForm selectedIndex="0">
      <ng-template matStepperIcon="number" let-index="index">
        {{ stepIndex + 1 }}
      </ng-template>

      <mat-step disableRipple="true" label="{{ templateStepForm?.get('step_title').value }}">
        <div [ngSwitch]="templateStepForm?.get('step_type').value">
          <ms-question-form-preview *ngSwitchCase="'question_and_field'" [currentStepIndex]="stepIndex"></ms-question-form-preview>
          <ms-question-form-preview *ngSwitchCase="'academic_journey'" [currentStepIndex]="stepIndex"></ms-question-form-preview>
          <ms-document-form-preview *ngSwitchCase="'document_expected'" [currentStepIndex]="stepIndex"></ms-document-form-preview>
          <!-- <ms-modality-payment-form-preview
            *ngSwitchCase="'modality_payment'"
            [currentStepIndex]="stepIndex"
          ></ms-modality-payment-form-preview> -->
          <!-- <ms-condition-acceptance-form-preview
            *ngSwitchCase="'document_to_validate'"
            [currentStepIndex]="stepIndex"
          ></ms-condition-acceptance-form-preview> -->
          <!-- <ms-down-payment-form-preview *ngSwitchCase="'down_payment_mode'" [currentStepIndex]="stepIndex"></ms-down-payment-form-preview> -->
          <!-- <ms-campus-validation-form-preview
            *ngSwitchCase="'campus_validation'"
            [currentStepIndex]="stepIndex"
          ></ms-campus-validation-form-preview> -->
          <!-- <ms-scholarship-fees-form-preview
            *ngSwitchCase="'scholarship_fee'"
            [currentStepIndex]="stepIndex"
          ></ms-scholarship-fees-form-preview> -->
          <!-- <ms-financement-form-preview *ngSwitchCase="'finance'" [currentStepIndex]="stepIndex"></ms-financement-form-preview> -->
        </div>
      </mat-step>
    </mat-horizontal-stepper>
  </div>
</div>

<div *ngIf="isWaitingForResponse" class="loading-indicator">
  <mat-progress-spinner mode="indeterminate" color="accent"></mat-progress-spinner>
</div>
