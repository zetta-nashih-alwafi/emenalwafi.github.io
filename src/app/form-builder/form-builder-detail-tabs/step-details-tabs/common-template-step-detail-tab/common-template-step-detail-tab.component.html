<div class="p-grid">
  <div style="text-align: start" class="p-col-1">
    <button matTooltip="{{ 'LEAVE' | translate }}" mat-raised-button color="warn" style="padding-left: 10px" (click)="leave()">
      <mat-icon class="mat-icon-default">keyboard_arrow_left</mat-icon>
      {{ 'LEAVE' | translate }}
    </button>
  </div>
  <div class="p-col-5 text-end-no-pad-r" [formGroup]="templateStepForm">
    <button
      matTooltip="{{ 'Save' | translate }}"
      mat-raised-button
      color="accent"
      [disabled]="!templateStepForm.valid || formIsSame() || validationOptionParentAndChild() || isPublished || !parentChildValidation"
      (click)="saveStepData()"
    >
      <mat-icon class="mat-icon-default">save</mat-icon>
      {{ 'Save' | translate }}
    </button>
  </div>
</div>

<div class="p-grid">
  <div class="p-col-6 form-side" style="margin-top: 2rem">
    <fieldset [disabled]="isPublished" style="padding: 0; border: none">
      <div [formGroup]="templateStepForm" class="p-grid yellow-border card-row">
        <div class="section-header">
          <h3>{{ templateStepForm.get('step_title').value }}</h3>
        </div>

        <div class="p-col-12">
          <div class="p-grid">
            <div class="p-col-12 no-padding-y">
              <mat-form-field class="full-width">
                <input
                  type="text"
                  formControlName="step_title"
                  matInput
                  required
                  placeholder="{{ 'ERP_009_TEACHER_CONTRACT.Step Title' | translate }}"
                  ngModel
                  maxlength="150"
                />
              </mat-form-field>
            </div>
          </div>

          <div class="p-grid">
            <div class="p-col-12 no-padding-y">
              <div *ngIf="templateStepForm?.get('direction')" class="ckeditor">
                <div class="p-grid">
                  <div class="p-col-6">
                    <label>{{ 'Header/Direction' | translate }}</label>
                  </div>
                  <ng-container>
                    <div class="p-col-6" style="text-align: end">
                      <button matTooltip="{{ 'List of keys' | translate }}" mat-raised-button color="accent" (click)="openTableKey()">
                        <mat-icon class="mat-icon-default">save</mat-icon>
                        {{ 'List of keys' | translate }}
                      </button>
                    </div>
                  </ng-container>
                </div>
                <ckeditor
                  #editor
                  [editor]="Editor"
                  [formControl]="templateStepForm.controls['direction']"
                  (ready)="onReady($event)"
                  [config]="config"
                  [disabled]="isPublished"
                ></ckeditor>
              </div>
            </div>
          </div>
        </div>

        <div class="p-col-12 text-end-no-pad-r">
          <button
            *ngIf="
              templateStepForm?.get('step_type').value === 'question_and_field' ||
              templateStepForm?.get('step_type').value === 'modality_payment'
            "
            matTooltip="{{ 'ERP_009_TEACHER_CONTRACT.Add Segment' | translate }}"
            mat-raised-button
            color="accent"
            [disabled]="!templateStepForm.get('step_type').value || isPublished"
            (click)="addSegmentForm('Open Dialog')"
          >
            {{ 'ERP_009_TEACHER_CONTRACT.Add Segment' | translate }}
          </button>
        </div>

        <div class="p-col-12 no-padding">
          <mat-accordion
            formArrayName="segments"
            [cdkDropListData]="getSegmentFormarray().controls"
            [multi]="true"
            cdkDropList
            (cdkDropListDropped)="dropSegment($event)"
          >
            <mat-expansion-panel
              *ngFor="let segment of getSegmentFormarray().controls; let segmentIndex = index"
              [formGroupName]="segmentIndex"
              style="background: #607d8b"
              [expanded]="true"
              cdkDrag
              [cdkDragDisabled]="isPublished"
            >
              <mat-expansion-panel-header cdkDragHandle>
                <mat-panel-title>
                  <h4 style="color: white; align-self: center; margin: 0px">{{ segment.get('segment_title').value }}</h4>
                </mat-panel-title>
              </mat-expansion-panel-header>

              <!-- Delete segment does not exist in step condition acceptance and document expected -->
              <div
                class="p-grid panel-divider"
                *ngIf="
                  templateStepForm?.get('step_type').value === 'question_and_field' ||
                  templateStepForm?.get('step_type').value === 'modality_payment'
                "
              >
                <div class="p-col-11"></div>
                <div class="p-col-1 text-right no-padding">
                  <button
                    matTooltip="{{ 'course_sequence.Remove' | translate }}"
                    (click)="removeSegmentForm(segmentIndex)"
                    mat-icon-button
                    class="small-icon"
                    color="red"
                    [disabled]="isPublished"
                  >
                    <mat-icon>remove</mat-icon>
                  </button>
                </div>
              </div>

              <!-- Only for modality payment step -->
              <ng-container *ngIf="templateStepForm?.get('step_type').value === 'modality_payment'">
                <!-- Segment title field -->
                <div class="p-grid">
                  <ng-container>
                    <div class="p-col-12">
                      <mat-form-field color="accent">
                        <input
                          #blockPanel
                          type="text"
                          formControlName="segment_title"
                          matInput
                          required
                          placeholder="{{ 'ERP_009_TEACHER_CONTRACT.Segment Title' | translate }}"
                        />
                      </mat-form-field>
                    </div>
                  </ng-container>
                </div>

                <!-- Include student toogle -->
                <div class="p-grid">
                  <div class="p-col-12">
                    <ng-container>
                      <mat-slide-toggle formControlName="is_student_included">
                        {{ 'Include student as financial support' | translate }}
                      </mat-slide-toggle>
                    </ng-container>
                  </div>
                </div>

                <!-- For modality question type is student -->
                <ng-container *ngIf="segment.get('is_student_included').value">
                  <div class="p-grid">
                    <div class="p-col-12 text-end-no-pad-r">
                      <button
                        matTooltip="{{ 'ERP_009_TEACHER_CONTRACT.Add Question' | translate }}"
                        mat-raised-button
                        color="accent"
                        (click)="addQuestionFieldForm(segmentIndex, 'student'); scrollIntoLastQuestion(segmentIndex, 'student')"
                        [disabled]="isPublished"
                      >
                        {{ 'ERP_009_TEACHER_CONTRACT.Add Student Question' | translate }}
                      </button>
                    </div>
                  </div>
                  <div class="p-grid">
                    <div
                      class="p-col-12 no-padding"
                      formArrayName="questions"
                      [cdkDropListData]="getQuestionFieldFormArray(segmentIndex).controls"
                      cdkDropList
                      (cdkDropListDropped)="dropQuestion($event, segmentIndex)"
                    >
                      <ng-container
                        *ngFor="let questionField of getQuestionFieldFormArray(segmentIndex).controls; let questionIndex = index"
                      >
                        <mat-card
                          class="mrgn-all-xs"
                          cdkDrag
                          [cdkDragDisabled]="isPublished"
                          *ngIf="questionField?.get('modality_question_type')?.value === 'student'"
                        >
                          <div #questionPanel>
                            <!-- QUESTION TYPE: NORMAL QUESTION AND FIELD BELOW ----------------------------------------------------------------------------------------------------->
                            <mat-card-content [formGroupName]="questionIndex" cdkDragHandle>
                              <div class="p-grid">
                                <div class="p-col-10" style="align-self: center; padding-bottom: 0px">
                                  <mat-slide-toggle
                                    [disabled]="isPublished"
                                    formControlName="is_field"
                                    (change)="updateFieldToggle($event, segmentIndex, questionIndex)"
                                  >
                                    <span [ngClass]="{ 'text-slider-color': questionField.get('is_field').value }">
                                      {{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD' | translate }}
                                    </span>
                                  </mat-slide-toggle>
                                  <mat-slide-toggle
                                    *ngIf="questionField.get('is_field').value"
                                    style="margin-left: 1rem"
                                    formControlName="is_editable"
                                    (change)="updateEditableToggle($event, segmentIndex, questionIndex)"
                                    [disabled]="isPublished"
                                  >
                                    <span [ngClass]="{ 'text-slider-color': questionField.get('is_editable').value }">
                                      {{
                                        (questionField.get('is_editable').value
                                          ? 'ERP_009_TEACHER_CONTRACT.Editable'
                                          : 'ERP_009_TEACHER_CONTRACT.Not Editable'
                                        ) | translate
                                      }}
                                    </span>
                                  </mat-slide-toggle>
                                  <mat-slide-toggle
                                    *ngIf="questionField.get('is_editable').value"
                                    style="margin-left: 1rem"
                                    formControlName="is_required"
                                    [disabled]="isPublished"
                                  >
                                    <span [ngClass]="{ 'text-slider-color': questionField.get('is_required').value }">
                                      {{
                                        (questionField.get('is_required').value
                                          ? 'ERP_009_TEACHER_CONTRACT.Required'
                                          : 'ERP_009_TEACHER_CONTRACT.Not Required'
                                        ) | translate
                                      }}
                                    </span>
                                  </mat-slide-toggle>
                                </div>
                                <div class="p-col-2" style="padding-bottom: 0px">
                                  <div style="text-align: right">
                                    <button
                                      matTooltip="{{ 'course_sequence.Remove' | translate }}"
                                      (click)="removeQuestionFieldForm(segmentIndex, questionIndex)"
                                      mat-icon-button
                                      class="small-icon"
                                      color="red"
                                      [disabled]="isPublished"
                                    >
                                      <mat-icon>remove</mat-icon>
                                    </button>
                                  </div>
                                </div>
                              </div>

                              <div class="p-grid">
                                <!-- Display the answer type if field is false -->
                                <ng-container>
                                  <div
                                    style="align-self: flex-end"
                                    [style.display]="!questionField.get('is_field').value ? 'block' : 'none'"
                                    class="p-col-3"
                                  >
                                    <mat-form-field>
                                      <input matInput formControlName="ref_id" [placeholder]="'REF_ID' | translate" type="text" />
                                    </mat-form-field>
                                  </div>
                                  <div [style.display]="!questionField.get('is_field').value ? 'block' : 'none'" class="p-col-5">
                                    <label
                                      class="float-label"
                                      [style.visibility]="questionField.get('answer_type').value ? 'visible' : 'hidden'"
                                    >
                                      {{ 'MENTOREVALUATION.QUESTIONNAIRE.ANSWER_TYPE' | translate }}
                                    </label>
                                    <ng-container>
                                      <ng-select
                                        placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.ANSWER_TYPE' | translate }}*"
                                        formControlName="answer_type"
                                        [clearable]="false"
                                        appendTo="body"
                                        [required]="!questionField.get('is_field').value"
                                        [disabled]="isPublished"
                                        (change)="onChangeAnswerType(segmentIndex, questionIndex, $event, 'student')"
                                      >
                                        <ng-option
                                          *ngFor="let questionAnswerType of questionnaireConsts.questionAnswerTypes"
                                          [value]="questionAnswerType.key"
                                          [disabled]="isPublished"
                                        >
                                          {{ 'QUESTION_ANSWER_TYPE.' + questionAnswerType.name.toUpperCase() | translate }}
                                        </ng-option>
                                      </ng-select>
                                    </ng-container>
                                  </div>
                                </ng-container>

                                <!-- Display the field dropdown if field is true -->
                                <ng-container>
                                  <div [style.display]="questionField.get('is_field').value ? 'block' : 'none'" class="p-col-4">
                                    <label
                                      class="float-label"
                                      [style.visibility]="questionField.get('field_type').value ? 'visible' : 'hidden'"
                                    >
                                      {{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_TYPE' | translate }}
                                    </label>
                                    <ng-select
                                      placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_TYPE' | translate }}*"
                                      formControlName="field_type"
                                      [clearable]="false"
                                      appendTo="body"
                                      [required]="questionField?.get('is_field').value"
                                      [disabled]="isPublished"
                                    >
                                      <ng-option
                                        [disabled]="isPublished"
                                        *ngFor="let field of questionnaireConsts?.modalityPaymentFieldType"
                                        [value]="field"
                                        >{{ '031_FORMBUILDER_MODALITYPAYMENT_FIELD.' + field | translate }}</ng-option
                                      >
                                    </ng-select>
                                  </div>
                                </ng-container>

                                <!-- Always display the position regardless field true/false -->
                                <ng-container>
                                  <div
                                    class="p-col-4"
                                    [style.visibility]="questionField.get('answer_type').value === 'long_text' ? 'hidden' : 'visible'"
                                  >
                                    <label
                                      class="float-label"
                                      [style.visibility]="questionField.get('field_position').value ? 'visible' : 'hidden'"
                                    >
                                      {{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_POSITION' | translate }}
                                    </label>
                                    <ng-select
                                      placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_POSITION' | translate }}*"
                                      formControlName="field_position"
                                      [clearable]="false"
                                      appendTo="body"
                                      [required]="questionField.get('answer_type').value !== 'long_text'"
                                      [disabled]="isPublished"
                                    >
                                      <ng-option *ngFor="let position of questionnaireConsts.questionPositions" [value]="position">{{
                                        'ERP_009_TEACHER_CONTRACT.POSITION.' + position | translate
                                      }}</ng-option>
                                    </ng-select>
                                  </div>
                                </ng-container>

                                <div
                                  [style.display]="
                                    !questionField.get('is_field').value && questionField.get('answer_type').value === 'numeric'
                                      ? 'contents'
                                      : 'none'
                                  "
                                  formGroupName="numeric_validation"
                                >
                                  <div class="p-col-fixed p-col-align-center pad-r-md">
                                    {{ 'Validation' | translate }}
                                  </div>
                                  <div class="p-col-3">
                                    <mat-form-field color="accent">
                                      <mat-label>{{ 'Condition' | translate }}</mat-label>
                                      <mat-select
                                        disableOptionCentering
                                        formControlName="condition"
                                        [required]="
                                          !questionField.get('is_field').value && questionField.get('answer_type').value === 'numeric'
                                        "
                                        panelClass="custom-matselect-dropdown"
                                      >
                                        <mat-option *ngFor="let condition of questionnaireConsts.numericConditions" [value]="condition">
                                          {{ condition | translate }}
                                        </mat-option>
                                      </mat-select>
                                      <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                    </mat-form-field>
                                  </div>
                                  <ng-container
                                    *ngIf="
                                      questionField.get('numeric_validation').get('condition').value === 'Between' ||
                                      questionField.get('numeric_validation').get('condition').value === 'Not between'
                                    "
                                  >
                                    <div class="p-col-2">
                                      <mat-form-field color="accent">
                                        <mat-label>{{ 'Number' | translate }}</mat-label>
                                        <input
                                          matInput
                                          type="number"
                                          (wheel)="onWheel($event)"
                                          formControlName="min_number"
                                          [required]="
                                            !questionField.get('is_field').value &&
                                            questionField.get('answer_type').value === 'numeric' &&
                                            (questionField.get('numeric_validation').get('condition').value === 'Between' ||
                                              questionField.get('numeric_validation').get('condition').value === 'Not between')
                                          "
                                        />
                                        <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                      </mat-form-field>
                                    </div>
                                    <div class="p-col-2">
                                      <mat-form-field color="accent">
                                        <mat-label>{{ 'Number' | translate }}</mat-label>
                                        <input
                                          matInput
                                          type="number"
                                          (wheel)="onWheel($event)"
                                          formControlName="max_number"
                                          [required]="
                                            !questionField.get('is_field').value &&
                                            questionField.get('answer_type').value === 'numeric' &&
                                            (questionField.get('numeric_validation').get('condition').value === 'Between' ||
                                              questionField.get('numeric_validation').get('condition').value === 'Not between')
                                          "
                                        />
                                        <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                      </mat-form-field>
                                    </div>
                                  </ng-container>
                                  <div
                                    class="p-col-2"
                                    [style.display]="
                                      questionField.value?.numeric_validation?.condition === 'Whole number' ||
                                      questionField.get('numeric_validation').get('condition').value === 'Between' ||
                                      questionField.get('numeric_validation').get('condition').value === 'Not between'
                                        ? 'none'
                                        : ''
                                    "
                                  >
                                    <mat-form-field color="accent">
                                      <mat-label>{{ 'Number' | translate }}</mat-label>
                                      <input
                                        matInput
                                        type="number"
                                        (wheel)="onWheel($event)"
                                        formControlName="number"
                                        [required]="
                                          !questionField.get('is_field').value &&
                                          questionField.get('answer_type').value === 'numeric' &&
                                          questionField.get('numeric_validation').get('condition').value !== 'Whole number' &&
                                          questionField.get('numeric_validation').get('condition').value !== 'Between' &&
                                          questionField.get('numeric_validation').get('condition').value !== 'Not between'
                                        "
                                      />
                                      <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                    </mat-form-field>
                                  </div>

                                  <div class="p-col">
                                    <mat-form-field color="accent">
                                      <mat-label>{{ 'Custom Error Text' | translate }}</mat-label>
                                      <input
                                        matInput
                                        type="text"
                                        formControlName="custom_error_text"
                                        [required]="
                                          !questionField.get('is_field').value && questionField.get('answer_type').value === 'numeric'
                                        "
                                      />
                                      <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                    </mat-form-field>
                                  </div>
                                </div>

                                <div
                                  formGroupName="multiple_option_validation"
                                  [style.display]="
                                    (!questionField.get('is_field').value &&
                                      questionField.get('answer_type').value === 'multiple_option') ||
                                    questionField.get('answer_type').value === 'dropdown_multiple_option'
                                      ? 'contents'
                                      : 'none'
                                  "
                                >
                                  <div class="p-col-fixed p-col-align-center pad-r-md">
                                    {{ 'Validation' | translate }}
                                  </div>
                                  <div class="p-col-3">
                                    <mat-form-field color="accent">
                                      <mat-label>{{ 'Selection Min/Max' | translate }}</mat-label>
                                      <mat-select
                                        disableOptionCentering
                                        formControlName="condition"
                                        [required]="
                                          (!questionField.get('is_field').value &&
                                            questionField.get('answer_type').value === 'multiple_option') ||
                                          questionField.get('answer_type').value === 'dropdown_multiple_option'
                                        "
                                        panelClass="custom-matselect-dropdown"
                                      >
                                        <mat-option
                                          *ngFor="let condition of questionnaireConsts.multipleOptionConditions"
                                          [value]="condition"
                                        >
                                          {{ condition | translate }}
                                        </mat-option>
                                      </mat-select>
                                      <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                    </mat-form-field>
                                  </div>
                                  <div class="p-col-2">
                                    <mat-form-field color="accent">
                                      <mat-label>{{ 'Number' | translate }}</mat-label>
                                      <input
                                        matInput
                                        type="number"
                                        (wheel)="onWheel($event)"
                                        formControlName="number"
                                        [required]="
                                          (!questionField.get('is_field').value &&
                                            questionField.get('answer_type').value === 'multiple_option') ||
                                          questionField.get('answer_type').value === 'dropdown_multiple_option'
                                        "
                                      />
                                      <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                    </mat-form-field>
                                  </div>
                                  <div class="p-col">
                                    <mat-form-field color="accent">
                                      <mat-label>{{ 'Custom Error Text' | translate }}</mat-label>
                                      <input
                                        matInput
                                        type="text"
                                        formControlName="custom_error_text"
                                        [required]="
                                          (!questionField.get('is_field').value &&
                                            questionField.get('answer_type').value === 'multiple_option') ||
                                          questionField.get('answer_type').value === 'dropdown_multiple_option'
                                        "
                                      />
                                      <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                    </mat-form-field>
                                  </div>
                                </div>

                                <div
                                  [style.display]="
                                    !questionField.get('is_field').value &&
                                    [
                                      'single_option',
                                      'single_option_diploma',
                                      'dropdown_single_option',
                                      'single_option_readmission_yes_or_no',
                                      'single_option_reason_not_readmission'
                                    ].includes(questionField.get('answer_type').value)
                                      ? 'contents'
                                      : 'none'
                                  "
                                >
                                  <div class="p-col-12">
                                    <mat-slide-toggle
                                      formControlName="is_router_on"
                                      (change)="onChangeRouter($event, segmentIndex, questionIndex, questionField.get('answer_type').value)"
                                    >
                                      {{ questionField.get('is_router_on').value ? ('Router ON' | translate) : ('Router OFF' | translate) }}
                                    </mat-slide-toggle>
                                  </div>
                                </div>

                                <div
                                  [style.display]="
                                    !questionField.get('is_field').value &&
                                    (questionField.get('answer_type').value === 'short_text' ||
                                      questionField.get('answer_type').value === 'long_text')
                                      ? 'contents'
                                      : 'none'
                                  "
                                  formGroupName="text_validation"
                                >
                                  <div class="p-col-fixed p-col-align-center pad-r-md">
                                    {{ 'Length' | translate }}
                                  </div>
                                  <div class="p-col-3">
                                    <mat-form-field color="accent">
                                      <mat-label>{{ 'Condition' | translate }}</mat-label>
                                      <mat-select
                                        disableOptionCentering
                                        formControlName="condition"
                                        [required]="
                                          !questionField.get('is_field').value &&
                                          (questionField.get('answer_type').value === 'short_text' ||
                                            questionField.get('answer_type').value === 'long_text')
                                        "
                                        panelClass="custom-matselect-dropdown"
                                      >
                                        <mat-option
                                          *ngFor="let condition of questionnaireConsts.textValidationCondition"
                                          [value]="condition"
                                        >
                                          {{ condition | translate }}
                                        </mat-option>
                                      </mat-select>
                                      <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                    </mat-form-field>
                                  </div>
                                  <div class="p-col-2">
                                    <mat-form-field color="accent">
                                      <mat-label>{{ 'Number' | translate }}</mat-label>
                                      <input
                                        matInput
                                        type="number"
                                        (wheel)="onWheel($event)"
                                        formControlName="number"
                                        [required]="
                                          !questionField.get('is_field').value &&
                                          (questionField.get('answer_type').value === 'short_text' ||
                                            questionField.get('answer_type').value === 'long_text')
                                        "
                                      />
                                      <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                    </mat-form-field>
                                  </div>
                                  <div class="p-col">
                                    <mat-form-field color="accent">
                                      <mat-label>{{ 'Custom Error Text' | translate }}</mat-label>
                                      <input
                                        matInput
                                        type="text"
                                        formControlName="custom_error_text"
                                        [required]="
                                          !questionField.get('is_field').value &&
                                          (questionField.get('answer_type').value === 'short_text' ||
                                            questionField.get('answer_type').value === 'long_text')
                                        "
                                      />
                                      <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                    </mat-form-field>
                                  </div>
                                </div>

                                <!-- For Question Name, only displayed if field false -->
                                <ng-container>
                                  <div [style.display]="!questionField.get('is_field').value ? 'block' : 'none'" class="p-col-12">
                                    <mat-form-field>
                                      <input
                                        matInput
                                        formControlName="question_label"
                                        [placeholder]="'Question Label' | translate"
                                        type="text"
                                        [readonly]="questionField.get('answer_type').value === 'single_option_diploma'"
                                        [required]="!questionField.get('is_field').value"
                                      />
                                    </mat-form-field>
                                  </div>
                                </ng-container>
                              </div>

                              <div class="row" [style.display]="checkIsParentChild(questionField?.value) ? 'flex' : 'none'">
                                <div class="p-col-8">
                                  <mat-form-field #parentChildOptionFormField color="accent" style="width: 100%">
                                    <input
                                      #parentChildOption
                                      matInput
                                      type="text"
                                      [placeholder]="'MENTOREVALUATION.QUESTIONNAIRE.OPTION.title' | translate"
                                      (focusout)="
                                        !parentChildOption.value && !questionField?.get('parent_child_options')?.value?.length
                                          ? parentChildOptionFormField?._elementRef?.nativeElement?.classList?.add('mat-form-field-invalid')
                                          : parentChildOptionFormField?._elementRef?.nativeElement?.classList?.remove(
                                              'mat-form-field-invalid'
                                            )
                                      "
                                      (keydown)="
                                        parentChildOptionFormField?._elementRef?.nativeElement?.classList?.remove('mat-form-field-invalid')
                                      "
                                      [required]="
                                        checkIsParentChild(questionField?.value) &&
                                        questionField?.get('parent_child_options')?.value?.length
                                      "
                                    />
                                  </mat-form-field>
                                  <mat-error
                                    *ngIf="
                                      parentChildOptionFormField?._elementRef?.nativeElement?.classList?.contains('mat-form-field-invalid')
                                    "
                                    >{{ 'This field is required' | translate }}</mat-error
                                  >
                                </div>
                                <div class="p-col-4">
                                  <button
                                    mat-mini-fab
                                    color="primary"
                                    type="button"
                                    (click)="addMoreAnswers(segmentIndex, questionIndex, parentChildOption)"
                                  >
                                    <mat-icon>add</mat-icon>
                                  </button>
                                </div>
                              </div>

                              <ul
                                style="flex-direction: column; list-style: none"
                                [style.display]="checkIsParentChild(questionField?.value) ? 'flex' : 'none'"
                              >
                                <li *ngFor="let option of questionField?.value?.parent_child_options; let optionIndex = index">
                                  <ms-step-parent-child-nesting
                                    [parent_child_options]="option"
                                    [question]="questionField.value"
                                    [optionIndex]="optionIndex"
                                    [formBuilderForm]="templateStepForm"
                                    [segmentIndex]="segmentIndex"
                                    [questionIndex]="questionIndex"
                                    [isViewOnly]="false"
                                    [parentAnswerType]="parentAnswerType"
                                  ></ms-step-parent-child-nesting>
                                </li>
                              </ul>

                              <div
                                class="p-grid p-align-center"
                                [style.display]="checkIsMutiOption(questionField?.value) ? 'flex' : 'none'"
                                *ngIf="
                                  questionField.get('answer_type').value !== 'single_option_diploma' &&
                                  questionField.get('answer_type').value !== 'single_option_readmission_yes_or_no'
                                "
                              >
                                <div class="p-col">
                                  <mat-form-field #formField color="accent" style="width: 100%">
                                    <input
                                      #optionInput
                                      matInput
                                      type="text"
                                      [placeholder]="'MENTOREVALUATION.QUESTIONNAIRE.OPTION.title' | translate"
                                      (focusout)="
                                        !optionInput?.value && !questionField?.get('options')?.value?.length
                                          ? formField?._elementRef?.nativeElement?.classList?.add('mat-form-field-invalid')
                                          : formField?._elementRef?.nativeElement?.classList?.remove('mat-form-field-invalid')
                                      "
                                      (keydown)="formField?._elementRef?.nativeElement?.classList?.remove('mat-form-field-invalid')"
                                      [required]="checkIsMutiOption(questionField?.value) && !questionField?.get('options')?.value?.length"
                                    />
                                  </mat-form-field>
                                  <mat-error
                                    class="manual-error"
                                    *ngIf="formField?._elementRef?.nativeElement?.classList?.contains('mat-form-field-invalid')"
                                    >{{ 'This field is required' | translate }}</mat-error
                                  >
                                </div>
                                <div class="p-col-fixed">
                                  <button
                                    [disabled]="isPublished || !optionInput.value"
                                    mat-mini-fab
                                    color="primary"
                                    type="button"
                                    type="button"
                                    (click)="addMoreOptions(segmentIndex, questionIndex, optionInput); optionInput.value = ''"
                                  >
                                    <mat-icon>add</mat-icon>
                                  </button>
                                </div>
                              </div>

                              <div
                                class="p-grid"
                                *ngIf="
                                  checkIsMutiOption(questionField?.value) &&
                                  questionField.get('answer_type').value !== 'single_option_readmission_yes_or_no'
                                "
                              >
                                <ng-container
                                  *ngFor="let option of getOptionsFormArrayFrom(questionField).controls; let optionIndex = index"
                                >
                                  <div class="p-col-12 no-padding" [formGroup]="option">
                                    <div class="p-grid p-align-center">
                                      <div class="p-col-6">
                                        <span style="text-align: right">{{ optionIndex + 1 }}) {{ option?.value?.option_name }} </span>
                                      </div>
                                      <div class="p-col-fixed">
                                        <button
                                          [disabled]="isPublished"
                                          matTooltip="{{ 'course_sequence.Remove' | translate }}"
                                          type="button"
                                          mat-icon-button
                                          (click)="removeOption(segmentIndex, questionIndex, optionIndex)"
                                          *ngIf="questionField.get('answer_type').value !== 'single_option_diploma'"
                                        >
                                          <mat-icon>delete</mat-icon>
                                        </button>
                                      </div>
                                      <div class="p-col no-padding" *ngIf="questionField.get('is_router_on')?.value">
                                        <mat-form-field color="accent">
                                          <mat-label>{{ 'Go to step' | translate }} *</mat-label>
                                          <input
                                            matInput
                                            formControlName="additional_step_name"
                                            [matAutocomplete]="nextStepAuto"
                                            (keyup)="onNextStepType($event, questionField, optionIndex, '')"
                                            (blur)="checkValueRouterOn(questionField, optionIndex)"
                                          />
                                          <mat-autocomplete
                                            #nextStepAuto
                                            [displayWith]="displayNextStepWithFn.bind(this)"
                                            [panelWidth]="'fit'"
                                          >
                                            <mat-option
                                              *ngFor="let option of filteredConditionalStepsDropdown"
                                              [value]="option?.step_title"
                                              (click)="onSelectNextStepAt(optionIndex, questionField, option)"
                                            >
                                              {{ option?.step_title }}
                                            </mat-option>
                                            <mat-option
                                              [value]="'Continue Next Step'"
                                              (click)="onSelectNextStepAt(optionIndex, questionField, 'Continue Next Step')"
                                            >
                                              {{ 'Continue Next Step' | translate }}
                                            </mat-option>
                                            <mat-option
                                              [value]="'Go To Final Step'"
                                              (click)="onSelectNextStepAt(optionIndex, questionField, 'Go To Final Step')"
                                            >
                                              {{ 'Go To Final Step' | translate }}
                                            </mat-option>
                                            <mat-option
                                              [value]="'Go To Final Message'"
                                              (click)="onSelectNextStepAt(optionIndex, questionField, 'Go To Final Message')"
                                            >
                                              {{ 'Go To Final Message' | translate }}
                                            </mat-option>
                                          </mat-autocomplete>
                                          <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                        </mat-form-field>
                                      </div>
                                    </div>
                                  </div>
                                </ng-container>
                              </div>
                            </mat-card-content>
                          </div>
                        </mat-card>
                      </ng-container>
                    </div>
                  </div>
                </ng-container>
                <!-- End for modality question type is student -->

                <!-- Multiple financial support toogle -->
                <div class="p-grid">
                  <div class="p-col-12">
                    <ng-container>
                      <mat-slide-toggle formControlName="is_multiple_financial_support">
                        {{ 'Multiple Financial Supports' | translate }}
                      </mat-slide-toggle>
                    </ng-container>
                  </div>
                </div>

                <!-- For modality question type is financial_support -->
                <div class="p-grid">
                  <div class="p-col-12 text-end-no-pad-r">
                    <button
                      matTooltip="{{ 'ERP_009_TEACHER_CONTRACT.Add Question' | translate }}"
                      mat-raised-button
                      color="accent"
                      (click)="addQuestionFieldForm(segmentIndex, 'financial_support'); scrollIntoLastQuestion(segmentIndex)"
                      [disabled]="isPublished"
                    >
                      {{ 'ERP_009_TEACHER_CONTRACT.Add Financial Support Question' | translate }}
                    </button>
                  </div>
                </div>
                <div class="p-grid">
                  <div
                    class="p-col-12 no-padding"
                    formArrayName="questions"
                    [cdkDropListData]="getQuestionFieldFormArray(segmentIndex).controls"
                    cdkDropList
                    (cdkDropListDropped)="dropQuestion($event, segmentIndex)"
                  >
                    <ng-container *ngFor="let questionField of getQuestionFieldFormArray(segmentIndex).controls; let questionIndex = index">
                      <mat-card
                        class="mrgn-all-xs"
                        cdkDrag
                        [cdkDragDisabled]="isPublished"
                        *ngIf="questionField?.get('modality_question_type')?.value === 'financial_support'"
                      >
                        <div #questionPanel>
                          <!-- QUESTION TYPE: NORMAL QUESTION AND FIELD BELOW ----------------------------------------------------------------------------------------------------->
                          <mat-card-content [formGroupName]="questionIndex" cdkDragHandle>
                            <div class="p-grid">
                              <div class="p-col-10" style="align-self: center; padding-bottom: 0px">
                                <mat-slide-toggle
                                  [disabled]="isPublished"
                                  formControlName="is_field"
                                  (change)="updateFieldToggle($event, segmentIndex, questionIndex)"
                                >
                                  <span [ngClass]="{ 'text-slider-color': questionField.get('is_field').value }">
                                    {{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD' | translate }}
                                  </span>
                                </mat-slide-toggle>
                                <mat-slide-toggle
                                  *ngIf="questionField.get('is_field').value"
                                  style="margin-left: 1rem"
                                  formControlName="is_editable"
                                  (change)="updateEditableToggle($event, segmentIndex, questionIndex)"
                                  [disabled]="isPublished"
                                >
                                  <span [ngClass]="{ 'text-slider-color': questionField.get('is_editable').value }">
                                    {{
                                      (questionField.get('is_editable').value
                                        ? 'ERP_009_TEACHER_CONTRACT.Editable'
                                        : 'ERP_009_TEACHER_CONTRACT.Not Editable'
                                      ) | translate
                                    }}
                                  </span>
                                </mat-slide-toggle>
                                <mat-slide-toggle
                                  *ngIf="questionField.get('is_editable').value"
                                  style="margin-left: 1rem"
                                  formControlName="is_required"
                                  [disabled]="isPublished"
                                >
                                  <span [ngClass]="{ 'text-slider-color': questionField.get('is_required').value }">
                                    {{
                                      (questionField.get('is_required').value
                                        ? 'ERP_009_TEACHER_CONTRACT.Required'
                                        : 'ERP_009_TEACHER_CONTRACT.Not Required'
                                      ) | translate
                                    }}
                                  </span>
                                </mat-slide-toggle>
                              </div>
                              <div class="p-col-2" style="padding-bottom: 0px">
                                <div style="text-align: right">
                                  <button
                                    matTooltip="{{ 'course_sequence.Remove' | translate }}"
                                    (click)="removeQuestionFieldForm(segmentIndex, questionIndex)"
                                    mat-icon-button
                                    class="small-icon"
                                    color="red"
                                    [disabled]="isPublished"
                                  >
                                    <mat-icon>remove</mat-icon>
                                  </button>
                                </div>
                              </div>
                            </div>

                            <div class="p-grid">
                              <!-- Display the answer type if field is false -->
                              <ng-container>
                                <div
                                  style="align-self: flex-end"
                                  [style.display]="!questionField.get('is_field').value ? 'block' : 'none'"
                                  class="p-col-3"
                                >
                                  <mat-form-field>
                                    <input matInput formControlName="ref_id" [placeholder]="'REF_ID' | translate" type="text" />
                                  </mat-form-field>
                                </div>
                                <div [style.display]="!questionField.get('is_field').value ? 'block' : 'none'" class="p-col-5">
                                  <label
                                    class="float-label"
                                    [style.visibility]="questionField.get('answer_type').value ? 'visible' : 'hidden'"
                                  >
                                    {{ 'MENTOREVALUATION.QUESTIONNAIRE.ANSWER_TYPE' | translate }}
                                  </label>
                                  <ng-container>
                                    <ng-select
                                      placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.ANSWER_TYPE' | translate }}*"
                                      formControlName="answer_type"
                                      [clearable]="false"
                                      appendTo="body"
                                      [required]="!questionField.get('is_field').value"
                                      [disabled]="isPublished"
                                      (change)="onChangeAnswerType(segmentIndex, questionIndex, $event, 'financial_support')"
                                    >
                                      <ng-option
                                        *ngFor="let questionAnswerType of questionnaireConsts.questionAnswerTypes"
                                        [value]="questionAnswerType.key"
                                        [disabled]="isPublished"
                                      >
                                        {{ 'QUESTION_ANSWER_TYPE.' + questionAnswerType.name.toUpperCase() | translate }}
                                      </ng-option>
                                    </ng-select>
                                  </ng-container>
                                </div>
                              </ng-container>

                              <!-- Display the field dropdown if field is true -->
                              <ng-container>
                                <div [style.display]="questionField.get('is_field').value ? 'block' : 'none'" class="p-col-4">
                                  <label
                                    class="float-label"
                                    [style.visibility]="questionField.get('field_type').value ? 'visible' : 'hidden'"
                                  >
                                    {{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_TYPE' | translate }}
                                  </label>

                                  <ng-select
                                    placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_TYPE' | translate }}*"
                                    formControlName="field_type"
                                    [clearable]="false"
                                    appendTo="body"
                                    [required]="questionField?.get('is_field').value"
                                    [disabled]="isPublished"
                                  >
                                    <ng-option
                                      [disabled]="isPublished"
                                      *ngFor="let field of questionnaireConsts?.modalityPaymentFieldType"
                                      [value]="field"
                                      >{{ '031_FORMBUILDER_MODALITYPAYMENT_FIELD.' + field | translate }}</ng-option
                                    >
                                  </ng-select>
                                </div>
                              </ng-container>

                              <!-- Always display the position regardless field true/false -->
                              <ng-container>
                                <div
                                  class="p-col-4"
                                  [style.visibility]="questionField.get('answer_type').value === 'long_text' ? 'hidden' : 'visible'"
                                >
                                  <label
                                    class="float-label"
                                    [style.visibility]="questionField.get('field_position').value ? 'visible' : 'hidden'"
                                  >
                                    {{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_POSITION' | translate }}
                                  </label>
                                  <ng-select
                                    placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_POSITION' | translate }}*"
                                    formControlName="field_position"
                                    [clearable]="false"
                                    appendTo="body"
                                    [required]="questionField.get('answer_type').value !== 'long_text'"
                                    [disabled]="isPublished"
                                  >
                                    <ng-option *ngFor="let position of questionnaireConsts.questionPositions" [value]="position">{{
                                      'ERP_009_TEACHER_CONTRACT.POSITION.' + position | translate
                                    }}</ng-option>
                                  </ng-select>
                                </div>
                              </ng-container>

                              <div
                                [style.display]="
                                  !questionField.get('is_field').value && questionField.get('answer_type').value === 'numeric'
                                    ? 'contents'
                                    : 'none'
                                "
                                formGroupName="numeric_validation"
                              >
                                <div class="p-col-fixed p-col-align-center pad-r-md">
                                  {{ 'Validation' | translate }}
                                </div>
                                <div class="p-col-3">
                                  <mat-form-field color="accent">
                                    <mat-label>{{ 'Condition' | translate }}</mat-label>
                                    <mat-select
                                      disableOptionCentering
                                      formControlName="condition"
                                      [required]="
                                        !questionField.get('is_field').value && questionField.get('answer_type').value === 'numeric'
                                      "
                                      panelClass="custom-matselect-dropdown"
                                    >
                                      <mat-option *ngFor="let condition of questionnaireConsts.numericConditions" [value]="condition">
                                        {{ condition | translate }}
                                      </mat-option>
                                    </mat-select>
                                    <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                  </mat-form-field>
                                </div>
                                <ng-container
                                  *ngIf="
                                    questionField.get('numeric_validation').get('condition').value === 'Between' ||
                                    questionField.get('numeric_validation').get('condition').value === 'Not between'
                                  "
                                >
                                  <div class="p-col-2">
                                    <mat-form-field color="accent">
                                      <mat-label>{{ 'Number' | translate }}</mat-label>
                                      <input
                                        matInput
                                        type="number"
                                        (wheel)="onWheel($event)"
                                        formControlName="min_number"
                                        [required]="
                                          !questionField.get('is_field').value &&
                                          questionField.get('answer_type').value === 'numeric' &&
                                          (questionField.get('numeric_validation').get('condition').value === 'Between' ||
                                            questionField.get('numeric_validation').get('condition').value === 'Not between')
                                        "
                                      />
                                      <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                    </mat-form-field>
                                  </div>
                                  <div class="p-col-2">
                                    <mat-form-field color="accent">
                                      <mat-label>{{ 'Number' | translate }}</mat-label>
                                      <input
                                        matInput
                                        type="number"
                                        (wheel)="onWheel($event)"
                                        formControlName="max_number"
                                        [required]="
                                          !questionField.get('is_field').value &&
                                          questionField.get('answer_type').value === 'numeric' &&
                                          (questionField.get('numeric_validation').get('condition').value === 'Between' ||
                                            questionField.get('numeric_validation').get('condition').value === 'Not between')
                                        "
                                      />
                                      <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                    </mat-form-field>
                                  </div>
                                </ng-container>
                                <div
                                  class="p-col-2"
                                  [style.display]="
                                    questionField.value?.numeric_validation?.condition === 'Whole number' ||
                                    questionField.get('numeric_validation').get('condition').value === 'Between' ||
                                    questionField.get('numeric_validation').get('condition').value === 'Not between'
                                      ? 'none'
                                      : ''
                                  "
                                >
                                  <mat-form-field color="accent">
                                    <mat-label>{{ 'Number' | translate }}</mat-label>
                                    <input
                                      matInput
                                      type="number"
                                      (wheel)="onWheel($event)"
                                      formControlName="number"
                                      [required]="
                                        !questionField.get('is_field').value &&
                                        questionField.get('answer_type').value === 'numeric' &&
                                        questionField.get('numeric_validation').get('condition').value !== 'Whole number' &&
                                        questionField.get('numeric_validation').get('condition').value !== 'Between' &&
                                        questionField.get('numeric_validation').get('condition').value !== 'Not between'
                                      "
                                    />
                                    <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                  </mat-form-field>
                                </div>

                                <div class="p-col">
                                  <mat-form-field color="accent">
                                    <mat-label>{{ 'Custom Error Text' | translate }}</mat-label>
                                    <input
                                      matInput
                                      type="text"
                                      formControlName="custom_error_text"
                                      [required]="
                                        !questionField.get('is_field').value && questionField.get('answer_type').value === 'numeric'
                                      "
                                    />
                                    <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                  </mat-form-field>
                                </div>
                              </div>

                              <div
                                formGroupName="multiple_option_validation"
                                [style.display]="
                                  (!questionField.get('is_field').value && questionField.get('answer_type').value === 'multiple_option') ||
                                  questionField.get('answer_type').value === 'dropdown_multiple_option'
                                    ? 'contents'
                                    : 'none'
                                "
                              >
                                <div class="p-col-fixed p-col-align-center pad-r-md">
                                  {{ 'Validation' | translate }}
                                </div>
                                <div class="p-col-3">
                                  <mat-form-field color="accent">
                                    <mat-label>{{ 'Selection Min/Max' | translate }}</mat-label>
                                    <mat-select
                                      disableOptionCentering
                                      formControlName="condition"
                                      [required]="
                                        (!questionField.get('is_field').value &&
                                          questionField.get('answer_type').value === 'multiple_option') ||
                                        questionField.get('answer_type').value === 'dropdown_multiple_option'
                                      "
                                      panelClass="custom-matselect-dropdown"
                                    >
                                      <mat-option
                                        *ngFor="let condition of questionnaireConsts.multipleOptionConditions"
                                        [value]="condition"
                                      >
                                        {{ condition | translate }}
                                      </mat-option>
                                    </mat-select>
                                    <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                  </mat-form-field>
                                </div>
                                <div class="p-col-2">
                                  <mat-form-field color="accent">
                                    <mat-label>{{ 'Number' | translate }}</mat-label>
                                    <input
                                      matInput
                                      type="number"
                                      (wheel)="onWheel($event)"
                                      formControlName="number"
                                      [required]="
                                        (!questionField.get('is_field').value &&
                                          questionField.get('answer_type').value === 'multiple_option') ||
                                        questionField.get('answer_type').value === 'dropdown_multiple_option'
                                      "
                                    />
                                    <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                  </mat-form-field>
                                </div>
                                <div class="p-col">
                                  <mat-form-field color="accent">
                                    <mat-label>{{ 'Custom Error Text' | translate }}</mat-label>
                                    <input
                                      matInput
                                      type="text"
                                      formControlName="custom_error_text"
                                      [required]="
                                        (!questionField.get('is_field').value &&
                                          questionField.get('answer_type').value === 'multiple_option') ||
                                        questionField.get('answer_type').value === 'dropdown_multiple_option'
                                      "
                                    />
                                    <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                  </mat-form-field>
                                </div>
                              </div>

                              <div
                                [style.display]="
                                  !questionField.get('is_field').value &&
                                  [
                                    'single_option',
                                    'single_option_diploma',
                                    'dropdown_single_option',
                                    'single_option_readmission_yes_or_no',
                                    'single_option_reason_not_readmission'
                                  ].includes(questionField.get('answer_type').value)
                                    ? 'contents'
                                    : 'none'
                                "
                              >
                                <div class="p-col-12">
                                  <mat-slide-toggle
                                    formControlName="is_router_on"
                                    (change)="onChangeRouter($event, segmentIndex, questionIndex, questionField.get('answer_type').value)"
                                  >
                                    {{ questionField.get('is_router_on').value ? ('Router ON' | translate) : ('Router OFF' | translate) }}
                                  </mat-slide-toggle>
                                </div>
                              </div>

                              <div
                                [style.display]="
                                  !questionField.get('is_field').value &&
                                  (questionField.get('answer_type').value === 'short_text' ||
                                    questionField.get('answer_type').value === 'long_text')
                                    ? 'contents'
                                    : 'none'
                                "
                                formGroupName="text_validation"
                              >
                                <div class="p-col-fixed p-col-align-center pad-r-md">
                                  {{ 'Length' | translate }}
                                </div>
                                <div class="p-col-3">
                                  <mat-form-field color="accent">
                                    <mat-label>{{ 'Condition' | translate }}</mat-label>
                                    <mat-select
                                      disableOptionCentering
                                      formControlName="condition"
                                      [required]="
                                        !questionField.get('is_field').value &&
                                        (questionField.get('answer_type').value === 'short_text' ||
                                          questionField.get('answer_type').value === 'long_text')
                                      "
                                      panelClass="custom-matselect-dropdown"
                                    >
                                      <mat-option *ngFor="let condition of questionnaireConsts.textValidationCondition" [value]="condition">
                                        {{ condition | translate }}
                                      </mat-option>
                                    </mat-select>
                                    <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                  </mat-form-field>
                                </div>
                                <div class="p-col-2">
                                  <mat-form-field color="accent">
                                    <mat-label>{{ 'Number' | translate }}</mat-label>
                                    <input
                                      matInput
                                      type="number"
                                      (wheel)="onWheel($event)"
                                      formControlName="number"
                                      [required]="
                                        !questionField.get('is_field').value &&
                                        (questionField.get('answer_type').value === 'short_text' ||
                                          questionField.get('answer_type').value === 'long_text')
                                      "
                                    />
                                    <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                  </mat-form-field>
                                </div>
                                <div class="p-col">
                                  <mat-form-field color="accent">
                                    <mat-label>{{ 'Custom Error Text' | translate }}</mat-label>
                                    <input
                                      matInput
                                      type="text"
                                      formControlName="custom_error_text"
                                      [required]="
                                        !questionField.get('is_field').value &&
                                        (questionField.get('answer_type').value === 'short_text' ||
                                          questionField.get('answer_type').value === 'long_text')
                                      "
                                    />
                                    <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                  </mat-form-field>
                                </div>
                              </div>

                              <!-- For Question Name, only displayed if field false -->
                              <ng-container>
                                <div [style.display]="!questionField.get('is_field').value ? 'block' : 'none'" class="p-col-12">
                                  <mat-form-field>
                                    <input
                                      matInput
                                      formControlName="question_label"
                                      [placeholder]="'Question Label' | translate"
                                      type="text"
                                      [readonly]="questionField.get('answer_type').value === 'single_option_diploma'"
                                      [required]="!questionField.get('is_field').value"
                                    />
                                  </mat-form-field>
                                </div>
                              </ng-container>
                            </div>

                            <div class="row" [style.display]="checkIsParentChild(questionField?.value) ? 'flex' : 'none'">
                              <div class="p-col-8">
                                <mat-form-field #parentChildOptionFormField color="accent" style="width: 100%">
                                  <input
                                    #parentChildOption
                                    matInput
                                    type="text"
                                    [placeholder]="'MENTOREVALUATION.QUESTIONNAIRE.OPTION.title' | translate"
                                    (focusout)="
                                      !parentChildOption.value && !questionField?.get('parent_child_options')?.value?.length
                                        ? parentChildOptionFormField?._elementRef?.nativeElement?.classList?.add('mat-form-field-invalid')
                                        : parentChildOptionFormField?._elementRef?.nativeElement?.classList?.remove(
                                            'mat-form-field-invalid'
                                          )
                                    "
                                    (keydown)="
                                      parentChildOptionFormField?._elementRef?.nativeElement?.classList?.remove('mat-form-field-invalid')
                                    "
                                    [required]="
                                      checkIsParentChild(questionField?.value) && questionField?.get('parent_child_options')?.value?.length
                                    "
                                  />
                                </mat-form-field>
                                <mat-error
                                  *ngIf="
                                    parentChildOptionFormField?._elementRef?.nativeElement?.classList?.contains('mat-form-field-invalid')
                                  "
                                  >{{ 'This field is required' | translate }}</mat-error
                                >
                              </div>
                              <div class="p-col-4">
                                <button
                                  mat-mini-fab
                                  color="primary"
                                  type="button"
                                  (click)="addMoreAnswers(segmentIndex, questionIndex, parentChildOption)"
                                >
                                  <mat-icon>add</mat-icon>
                                </button>
                              </div>
                            </div>

                            <ul
                              style="flex-direction: column; list-style: none"
                              [style.display]="checkIsParentChild(questionField?.value) ? 'flex' : 'none'"
                            >
                              <li *ngFor="let option of questionField?.value?.parent_child_options; let optionIndex = index">
                                <ms-step-parent-child-nesting
                                  [parent_child_options]="option"
                                  [question]="questionField.value"
                                  [optionIndex]="optionIndex"
                                  [formBuilderForm]="templateStepForm"
                                  [segmentIndex]="segmentIndex"
                                  [questionIndex]="questionIndex"
                                  [isViewOnly]="false"
                                  [parentAnswerType]="parentAnswerType"
                                ></ms-step-parent-child-nesting>
                              </li>
                            </ul>

                            <div
                              class="p-grid p-align-center"
                              [style.display]="checkIsMutiOption(questionField?.value) ? 'flex' : 'none'"
                              *ngIf="
                                questionField.get('answer_type').value !== 'single_option_diploma' &&
                                questionField.get('answer_type').value !== 'single_option_readmission_yes_or_no'
                              "
                            >
                              <div class="p-col">
                                <mat-form-field #formField color="accent" style="width: 100%">
                                  <input
                                    #optionInput
                                    matInput
                                    type="text"
                                    [placeholder]="'MENTOREVALUATION.QUESTIONNAIRE.OPTION.title' | translate"
                                    (focusout)="
                                      !optionInput?.value && !questionField?.get('options')?.value?.length
                                        ? formField?._elementRef?.nativeElement?.classList?.add('mat-form-field-invalid')
                                        : formField?._elementRef?.nativeElement?.classList?.remove('mat-form-field-invalid')
                                    "
                                    (keydown)="formField?._elementRef?.nativeElement?.classList?.remove('mat-form-field-invalid')"
                                    [required]="checkIsMutiOption(questionField?.value) && !questionField?.get('options')?.value?.length"
                                  />
                                </mat-form-field>
                                <mat-error
                                  class="manual-error"
                                  *ngIf="formField?._elementRef?.nativeElement?.classList?.contains('mat-form-field-invalid')"
                                  >{{ 'This field is required' | translate }}</mat-error
                                >
                              </div>
                              <div class="p-col-fixed">
                                <button
                                  [disabled]="isPublished || !optionInput.value"
                                  mat-mini-fab
                                  color="primary"
                                  type="button"
                                  type="button"
                                  (click)="addMoreOptions(segmentIndex, questionIndex, optionInput); optionInput.value = ''"
                                >
                                  <mat-icon>add</mat-icon>
                                </button>
                              </div>
                            </div>

                            <div
                              class="p-grid"
                              *ngIf="
                                checkIsMutiOption(questionField?.value) &&
                                questionField.get('answer_type').value !== 'single_option_readmission_yes_or_no'
                              "
                            >
                              <ng-container *ngFor="let option of getOptionsFormArrayFrom(questionField).controls; let optionIndex = index">
                                <div class="p-col-12 no-padding" [formGroup]="option">
                                  <div class="p-grid p-align-center">
                                    <div class="p-col-6">
                                      <span style="text-align: right">{{ optionIndex + 1 }}) {{ option?.value?.option_name }} </span>
                                    </div>
                                    <div class="p-col-fixed">
                                      <button
                                        [disabled]="isPublished"
                                        matTooltip="{{ 'course_sequence.Remove' | translate }}"
                                        type="button"
                                        mat-icon-button
                                        (click)="removeOption(segmentIndex, questionIndex, optionIndex)"
                                        *ngIf="questionField.get('answer_type').value !== 'single_option_diploma'"
                                      >
                                        <mat-icon>delete</mat-icon>
                                      </button>
                                    </div>
                                    <div class="p-col no-padding" *ngIf="questionField.get('is_router_on')?.value">
                                      <mat-form-field color="accent">
                                        <mat-label>{{ 'Go to step' | translate }} *</mat-label>
                                        <input
                                          matInput
                                          formControlName="additional_step_name"
                                          [matAutocomplete]="nextStepAuto"
                                          (keyup)="onNextStepType($event, questionField, optionIndex, '')"
                                          (blur)="checkValueRouterOn(questionField, optionIndex)"
                                        />
                                        <mat-autocomplete
                                          #nextStepAuto
                                          [displayWith]="displayNextStepWithFn.bind(this)"
                                          [panelWidth]="'fit'"
                                        >
                                          <mat-option
                                            *ngFor="let option of filteredConditionalStepsDropdown"
                                            [value]="option?.step_title"
                                            (click)="onSelectNextStepAt(optionIndex, questionField, option)"
                                          >
                                            {{ option?.step_title }}
                                          </mat-option>
                                          <mat-option
                                            [value]="'Continue Next Step'"
                                            (click)="onSelectNextStepAt(optionIndex, questionField, 'Continue Next Step')"
                                          >
                                            {{ 'Continue Next Step' | translate }}
                                          </mat-option>
                                          <mat-option
                                            [value]="'Go To Final Step'"
                                            (click)="onSelectNextStepAt(optionIndex, questionField, 'Go To Final Step')"
                                          >
                                            {{ 'Go To Final Step' | translate }}
                                          </mat-option>
                                          <mat-option
                                            [value]="'Go To Final Message'"
                                            (click)="onSelectNextStepAt(optionIndex, questionField, 'Go To Final Message')"
                                          >
                                            {{ 'Go To Final Message' | translate }}
                                          </mat-option>
                                        </mat-autocomplete>
                                        <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                      </mat-form-field>
                                    </div>
                                  </div>
                                </div>
                              </ng-container>
                            </div>

                            <!-- <div class="p-grid" *ngIf="questionField.get('answer_type').value === 'single_option_readmission_yes_or_no'">
                              <ng-container *ngFor="let option of getOptionsFormArrayFrom(questionField).controls; let optionIndex = index">
                                <div class="p-col-6" [formGroup]="option">
                                  <div class="p-grid">
                                    <div class="p-col-3">
                                      <div style="text-align: left">{{ optionIndex + 1 }}) {{ option?.value?.option_name }} </div>
                                    </div>
                                    <div class="p-col-9 mt-8">
                                      <mat-form-field color="accent">
                                        <mat-label>{{ 'Answer Label' | translate }}</mat-label>
                                        <input
                                          matInput
                                          type="text"
                                          (change)="handleChangeAnswerLabel($event, segmentIndex, questionIndex,optionIndex)"
                                          [required]="
                                            !questionField.get('is_field').value &&
                                            (questionField.get('answer_type').value === 'single_option_readmission_yes_or_no')
                                          "
                                        />
                                        <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                      </mat-form-field>
                                    </div>
                                  </div>
                                </div>
                                <div class="p-col-fixed">
                                  <button
                                    [disabled]="isPublished"
                                    type="button"
                                    mat-icon-button
                                    matTooltip="{{ 'course_sequence.Remove' | translate }}"
                                    *ngIf="questionField.get('answer_type').value !== 'single_option_readmission_yes_or_no'"
                                  >
                                    <mat-icon>delete</mat-icon>
                                  </button>
                                </div>
                                <div class="p-col" *ngIf="questionField.get('is_router_on')?.value">
                                  <mat-form-field color="accent">
                                    <mat-label>{{ 'Go to step' | translate }} </mat-label>
                                    <input
                                      required
                                      matInput
                                      formControlName="additional_step_name"
                                      [matAutocomplete]="nextStepAuto"
                                      (keyup)="onNextStepType($event)"
                                    />
                                    <mat-autocomplete #nextStepAuto [displayWith]="displayNextStepWithFn.bind(this)" [panelWidth]="'fit'">
                                      <mat-option
                                        *ngFor="let option of filteredConditionalStepsDropdown"
                                        [value]="option?.step_title"
                                        (click)="onSelectNextStepAt(optionIndex, questionField, option)"
                                      >
                                        {{ option?.step_title }}
                                      </mat-option>
                                      <mat-option
                                        [value]="'Continue Next Step'"
                                        (click)="onSelectNextStepAt(optionIndex, questionField, 'Continue Next Step')"
                                      >
                                        {{ 'Continue Next Step' | translate }}
                                      </mat-option>
                                      <mat-option
                                        [value]="'Go To Final Step'"
                                        (click)="onSelectNextStepAt(optionIndex, questionField, 'Go To Final Step')"
                                      >
                                        {{ 'Go To Final Step' | translate }}
                                      </mat-option>
                                      <mat-option
                                        [value]="'Go To Final Message'"
                                        (click)="onSelectNextStepAt(optionIndex, questionField, 'Go To Final Message')"
                                      >
                                        {{ 'Go To Final Message' | translate }}
                                      </mat-option>
                                    </mat-autocomplete>
                                    <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                  </mat-form-field>
                                </div>
                              </ng-container>
                            </div> -->
                          </mat-card-content>
                        </div>
                      </mat-card>
                    </ng-container>
                  </div>
                </div>
                <!-- End for modality question type is financial_support -->
              </ng-container>

              <!-- For other than modality payment step -->
              <ng-container *ngIf="templateStepForm?.get('step_type').value !== 'modality_payment'">
                <div class="p-grid">
                  <!-- Segment title doesn't exist in step document expected -->
                  <ng-container>
                    <div class="p-col-12">
                      <mat-form-field color="accent">
                        <input
                          #blockPanel
                          type="text"
                          formControlName="segment_title"
                          matInput
                          required
                          placeholder="{{ 'ERP_009_TEACHER_CONTRACT.Segment Title' | translate }}"
                        />
                      </mat-form-field>
                    </div>
                  </ng-container>

                  <!-- Document type for certification acceptance is only for step condition acceptance -->
                  <ng-container *ngIf="templateStepForm?.get('step_type').value === 'condition_acceptance'">
                    <div class="p-col-12" style="padding-top: 0px">
                      <ng-select
                        formControlName="document_for_condition"
                        [clearable]="false"
                        appendTo="body"
                        required
                        (change)="handleDocumentSelected($event, segmentIndex)"
                        placeholder="{{ 'Document for condition' | translate }}*"
                        [disabled]="isPublished"
                      >
                        <ng-option *ngFor="let type of docListType" [value]="type">{{ type | translate }}</ng-option>
                      </ng-select>
                    </div>

                    <div style="width: 99% !important" class="p-col-12 no-padding-y" *ngIf="selectedDocType === 'ck_editor'">
                      <div class="ckeditor">
                        <ckeditor
                          #editor
                          [editor]="Editor"
                          formControlName="acceptance_text"
                          (ready)="onReady($event)"
                          [config]="configTypeCondition"
                          [disabled]="isPublished"
                        ></ckeditor>
                      </div>
                    </div>

                    <div class="p-col-12 no-padding-y" *ngIf="selectedDocType === 'upload_pdf'">
                      <ng-container *ngIf="!listUploadDocumentPDF">
                        <button mat-raised-button color="accent" (click)="openUploadWindow()" [disabled]="isPublished">
                          <mat-icon>file_upload</mat-icon> {{ 'Upload PDF for user to accept' | translate }}
                        </button>
                        <input #fileUploadDoc type="file" accept=".pdf" class="hidden" (change)="chooseFile($event, segmentIndex)" />
                      </ng-container>
                      <div class="p-grid" *ngIf="listUploadDocumentPDF" style="padding-top: 15px">
                        <input #fileUploadDoc type="file" accept=".pdf" class="hidden" (change)="chooseFile($event, segmentIndex)" />
                        <div class="p-col-2">
                          <button
                            [disabled]="isPublished"
                            (click)="openUploadWindow()"
                            mat-icon-button
                            matTooltip="{{ 'Edit' | translate }}"
                          >
                            <mat-icon style="color: black">edit</mat-icon>
                          </button>
                          <button
                            [disabled]="isPublished"
                            (click)="deletePDF(segmentIndex)"
                            mat-icon-button
                            matTooltip="{{ 'Delete' | translate }}"
                          >
                            <mat-icon style="color: black">delete</mat-icon>
                          </button>
                        </div>
                        <div class="p-col-10" style="margin-top: 6px">
                          {{ listUploadDocumentPDF }}
                        </div>
                      </div>
                    </div>

                    <div class="p-col-12">
                      <mat-slide-toggle formControlName="is_rejection_allowed" (change)="onAllowRejectionChange($event, segment)">
                        {{
                          segment.get('is_rejection_allowed').value
                            ? ('Reject is allowed' | translate)
                            : ('Reject is not allowed' | translate)
                        }}
                      </mat-slide-toggle>
                    </div>
                    <div class="p-col-12 pad-l-lg" *ngIf="segment.get('is_rejection_allowed').value">
                      <mat-slide-toggle class="pad-l-lg" formControlName="is_on_reject_complete_the_step">
                        {{
                          segment.get('is_on_reject_complete_the_step').value
                            ? ('On reject complete the form' | translate)
                            : ('On reject continue to next step' | translate)
                        }}
                      </mat-slide-toggle>
                    </div>
                    <div class="p-col-12">
                      <mat-slide-toggle formControlName="is_download_mandatory">
                        {{
                          segment.get('is_download_mandatory').value
                            ? ('Mandatory for user to download before able to complete the step' | translate)
                            : ('Not Mandatory for user to download before able to complete the step' | translate)
                        }}
                      </mat-slide-toggle>
                    </div>
                    <div class="p-col-12 p-grid p-align-baseline">
                      <div class="p-col-2">{{ 'Accept button' | translate }} :</div>
                      <div class="p-col">
                        <mat-form-field color="accent">
                          <mat-label>{{ 'Accept button' | translate }}</mat-label>
                          <input
                            matInput
                            type="text"
                            formControlName="accept_button"
                            [required]="templateStepForm?.get('step_type').value === 'condition_acceptance' ? true : false"
                          />
                          <mat-error>{{ 'This field is required' | translate }}</mat-error>
                        </mat-form-field>
                      </div>
                    </div>
                    <div class="p-col-12 p-grid p-align-baseline" *ngIf="segment.get('is_rejection_allowed').value">
                      <div class="p-col-2">{{ 'Reject button' | translate }} :</div>
                      <div class="p-col">
                        <mat-form-field color="accent">
                          <mat-label>{{ 'Reject button' | translate }} *</mat-label>
                          <input matInput type="text" formControlName="reject_button" />
                          <mat-error>{{ 'This field is required' | translate }}</mat-error>
                        </mat-form-field>
                      </div>
                    </div>
                  </ng-container>

                  <!-- Add Question does not exist in step condition acceptance -->
                  <ng-container
                    *ngIf="
                      templateStepForm?.get('step_type').value === 'condition_acceptance' ||
                        templateStepForm?.get('step_type').value === 'step_summary' ||
                        templateStepForm?.get('step_type').value === 'finance' ||
                        templateStepForm?.get('step_type').value === 'campus_validation' ||
                        templateStepForm?.get('step_type').value === 'final_message';
                      else addQuestion
                    "
                  >
                  </ng-container>
                  <ng-template #addQuestion>
                    <div class="p-col-12 text-end-no-pad-r">
                      <button
                        matTooltip="{{ 'ERP_009_TEACHER_CONTRACT.Add Question' | translate }}"
                        mat-raised-button
                        color="accent"
                        (click)="addQuestionFieldForm(segmentIndex); scrollIntoLastQuestion(segmentIndex)"
                        [disabled]="
                          isPublished ||
                          (templateType === 'quality_file' &&
                            templateStepForm?.get('step_type').value === 'document_expected' &&
                            segment.get('questions').value.length >= 1)
                        "
                        *ngIf="
                          templateStepForm?.get('step_type').value !== 'summary' &&
                          templateStepForm?.get('step_type').value !== 'document_to_validate'
                        "
                      >
                        {{ 'ERP_009_TEACHER_CONTRACT.Add Question' | translate }}
                      </button>
                    </div>
                  </ng-template>
                </div>

                <div class="p-grid">
                  <div
                    class="p-col-12 no-padding"
                    formArrayName="questions"
                    [cdkDropListData]="getQuestionFieldFormArray(segmentIndex).controls"
                    cdkDropList
                    (cdkDropListDropped)="dropQuestion($event, segmentIndex)"
                  >
                    <mat-card
                      class="mrgn-all-xs"
                      *ngFor="let questionField of getQuestionFieldFormArray(segmentIndex).controls; let questionIndex = index"
                      cdkDrag
                      [cdkDragDisabled]="
                        isPublished ||
                        templateStepForm?.get('step_type').value === 'summary' ||
                        templateStepForm?.get('step_type').value === 'final_message' ||
                        templateStepForm?.get('step_type').value === 'campus_validation'
                      "
                    >
                      <div #questionPanel>
                        <!-- QUESTION TYPE: EXPECTED DOCUMENT AND FIELD BELOW ----------------------------------------------------------------------------------------------------->
                        <mat-card-content
                          *ngIf="this.templateStepForm.get('step_type').value === 'document_expected'"
                          [formGroupName]="questionIndex"
                          cdkDragHandle
                        >
                          <div class="p-grid">
                            <!-- The toggles row -->
                            <div class="p-col-10" style="align-self: center; padding-bottom: 0px">
                              <!-- for now step document expected field toggle hide and is field default false -->
                              <mat-slide-toggle
                                [disabled]="isPublished"
                                formControlName="is_field"
                                (change)="updateFieldToggle($event, segmentIndex, questionIndex)"
                                *ngIf="this.templateStepForm.get('step_type').value !== 'document_expected'"
                              >
                                <span [ngClass]="{ 'text-slider-color': questionField.get('is_field').value }">
                                  {{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD' | translate }}
                                </span>
                              </mat-slide-toggle>
                              <mat-slide-toggle formControlName="is_required" [disabled]="isPublished">
                                <span [ngClass]="{ 'text-slider-color': questionField.get('is_required').value }">
                                  {{
                                    (questionField.get('is_required').value
                                      ? 'ERP_009_TEACHER_CONTRACT.Required'
                                      : 'ERP_009_TEACHER_CONTRACT.Not Required'
                                    ) | translate
                                  }}
                                </span>
                              </mat-slide-toggle>
                            </div>
                            <div class="p-col-2" style="padding-bottom: 0px">
                              <div style="text-align: right">
                                <button
                                  [disabled]="isPublished"
                                  matTooltip="{{ 'course_sequence.Remove' | translate }}"
                                  (click)="removeQuestionFieldForm(segmentIndex, questionIndex)"
                                  mat-icon-button
                                  class="small-icon"
                                  color="red"
                                >
                                  <mat-icon>remove</mat-icon>
                                </button>
                              </div>
                            </div>
                          </div>

                          <div class="p-grid">
                            <div class="p-col-8">
                              <label class="float-label" [style.visibility]="questionField.get('answer_type').value ? 'visible' : 'hidden'">
                                {{ 'MENTOREVALUATION.QUESTIONNAIRE.ANSWER_TYPE' | translate }}*
                              </label>
                              <ng-select
                                class="custom-class"
                                placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.ANSWER_TYPE' | translate }}*"
                                formControlName="answer_type"
                                [clearable]="false"
                                appendTo="body"
                                required
                                [disabled]="isPublished"
                                (change)="onCheckAnswerType($event, segmentIndex, questionIndex); filterSelectedAnswerType()"
                              >
                                <ng-option
                                  *ngFor="let questionAnswerType of questionnaireConsts.expectedDocumentTypes"
                                  [value]="questionAnswerType.value"
                                  [disabled]="selectedAnswerType?.includes(questionAnswerType?.value)"
                                  >{{ 'EXPECTED_DOCUMENT_TYPES.' + questionAnswerType.view | translate }}</ng-option
                                >
                              </ng-select>
                            </div>
                          </div>

                          <!-- Second row, question label, only if non-field -->
                          <div class="p-grid">
                            <div [style.display]="questionField.get('is_field').value ? 'block' : 'none'" class="p-col-4">
                              <label class="float-label" [style.visibility]="questionField.get('field_type').value ? 'visible' : 'hidden'">
                                {{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_TYPE' | translate }}
                              </label>
                              <ng-select
                                placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_TYPE' | translate }}*"
                                formControlName="field_type"
                                [clearable]="false"
                                appendTo="body"
                                [required]="questionField.get('is_field').value"
                                [disabled]="isPublished"
                                (change)="selectDocumentExpectedType($event, segmentIndex, questionIndex)"
                              >
                                <ng-option
                                  [disabled]="isPublished"
                                  *ngFor="let field of questionnaireConsts.documentExpectedFields"
                                  [value]="field"
                                >
                                  {{ 'FORM_BUILDER_FIELD.' + field | translate }}
                                </ng-option>
                              </ng-select>
                              <mat-error
                                class="manual-error"
                                *ngIf="
                                  questionField?.get('field_type')?.hasError('required') &&
                                  questionField?.get('field_type')?.invalid &&
                                  questionField?.get('field_type')?.touched
                                "
                              >
                                {{ 'This field is required' | translate }}
                              </mat-error>
                            </div>
                            <div
                              *ngIf="questionField.get('answer_type').value === 'document_pdf_upload'"
                              [style.display]="!questionField.get('is_field').value ? 'block' : 'none'"
                              class="p-col-12"
                            >
                              <mat-form-field>
                                <input
                                  required
                                  matInput
                                  formControlName="question_label"
                                  [placeholder]="'Question Label' | translate"
                                  type="text"
                                  [readonly]="isPublished || questionField?.get('answer_type')?.value === 'single_option_diploma'"
                                />
                                <mat-error>{{ 'This field is required' | translate }}</mat-error>
                              </mat-form-field>
                            </div>
                          </div>
                        </mat-card-content>

                        <!-- QUESTION TYPE: NORMAL QUESTION AND FIELD BELOW ----------------------------------------------------------------------------------------------------->
                        <mat-card-content
                          *ngIf="this.templateStepForm.get('step_type').value === 'question_and_field'"
                          [formGroupName]="questionIndex"
                          cdkDragHandle
                        >
                          <div class="p-grid">
                            <div class="p-col-10" style="align-self: center; padding-bottom: 0px">
                              <mat-slide-toggle
                                [disabled]="isPublished"
                                formControlName="is_field"
                                (change)="updateFieldToggle($event, segmentIndex, questionIndex)"
                              >
                                <span [ngClass]="{ 'text-slider-color': questionField.get('is_field').value }">
                                  {{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD' | translate }}
                                </span>
                              </mat-slide-toggle>
                              <mat-slide-toggle
                                *ngIf="questionField.get('is_field').value"
                                style="margin-left: 1rem"
                                formControlName="is_editable"
                                (change)="updateEditableToggle($event, segmentIndex, questionIndex)"
                                [disabled]="isPublished"
                              >
                                <span [ngClass]="{ 'text-slider-color': questionField.get('is_editable').value }">
                                  {{
                                    (questionField.get('is_editable').value
                                      ? 'ERP_009_TEACHER_CONTRACT.Editable'
                                      : 'ERP_009_TEACHER_CONTRACT.Not Editable'
                                    ) | translate
                                  }}
                                </span>
                              </mat-slide-toggle>
                              <mat-slide-toggle
                                *ngIf="questionField.get('is_editable').value"
                                style="margin-left: 1rem"
                                formControlName="is_required"
                                [disabled]="isPublished"
                              >
                                <span [ngClass]="{ 'text-slider-color': questionField.get('is_required').value }">
                                  {{
                                    (questionField.get('is_required').value
                                      ? 'ERP_009_TEACHER_CONTRACT.Required'
                                      : 'ERP_009_TEACHER_CONTRACT.Not Required'
                                    ) | translate
                                  }}
                                </span>
                              </mat-slide-toggle>
                            </div>
                            <div class="p-col-2" style="padding-bottom: 0px">
                              <div style="text-align: right">
                                <button
                                  matTooltip="{{ 'course_sequence.Remove' | translate }}"
                                  (click)="removeQuestionFieldForm(segmentIndex, questionIndex)"
                                  mat-icon-button
                                  class="small-icon"
                                  color="red"
                                  [disabled]="isPublished"
                                >
                                  <mat-icon>remove</mat-icon>
                                </button>
                              </div>
                            </div>
                          </div>

                          <div class="p-grid">
                            <!-- Display the answer type if field is false -->
                            <ng-container>
                              <div
                                style="align-self: flex-end"
                                [style.display]="!questionField.get('is_field').value ? 'block' : 'none'"
                                class="p-col-3"
                              >
                                <mat-form-field>
                                  <input matInput formControlName="ref_id" [placeholder]="'REF_ID' | translate" type="text" />
                                </mat-form-field>
                              </div>
                              <div [style.display]="!questionField.get('is_field').value ? 'block' : 'none'" class="p-col-5">
                                <label
                                  class="float-label"
                                  [style.visibility]="questionField.get('answer_type').value ? 'visible' : 'hidden'"
                                >
                                  {{ 'MENTOREVALUATION.QUESTIONNAIRE.ANSWER_TYPE' | translate }}
                                </label>
                                <ng-container *ngIf="templateType !== 'admission_document' && templateType !== 'one_time_form'">
                                  <ng-select
                                    placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.ANSWER_TYPE' | translate }}*"
                                    formControlName="answer_type"
                                    [clearable]="false"
                                    appendTo="body"
                                    [required]="!questionField.get('is_field').value"
                                    [disabled]="isPublished"
                                    (change)="onChangeAnswerType(segmentIndex, questionIndex, $event)"
                                  >
                                    <ng-option
                                      *ngFor="let questionAnswerType of questionnaireConsts.questionAnswerTypes"
                                      [value]="questionAnswerType.key"
                                      [disabled]="isPublished"
                                    >
                                      {{ 'QUESTION_ANSWER_TYPE.' + questionAnswerType.name.toUpperCase() | translate }}
                                    </ng-option>
                                  </ng-select>
                                  <mat-error
                                    class="manual-error"
                                    *ngIf="
                                      questionField?.get('answer_type')?.hasError('required') &&
                                      questionField?.get('answer_type')?.invalid &&
                                      questionField?.get('answer_type')?.touched
                                    "
                                  >
                                    {{ 'This field is required' | translate }}
                                  </mat-error>
                                </ng-container>
                                <ng-container *ngIf="templateType === 'admission_document'">
                                  <ng-select
                                    placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.ANSWER_TYPE' | translate }}*"
                                    formControlName="answer_type"
                                    [clearable]="false"
                                    appendTo="body"
                                    [required]="!questionField.get('is_field').value"
                                    [disabled]="isPublished"
                                    (change)="checkAnswerType(segmentIndex, questionIndex, $event)"
                                  >
                                    <ng-option
                                      *ngFor="let questionAnswerType of questionnaireConsts.questionAnswerTypesAdmissionDocument"
                                      [value]="questionAnswerType.key"
                                      [disabled]="isPublished"
                                    >
                                      {{ 'QUESTION_ANSWER_TYPE.' + questionAnswerType.name.toUpperCase() | translate }}
                                    </ng-option>
                                  </ng-select>
                                </ng-container>
                                <ng-container *ngIf="templateType === 'one_time_form'">
                                  <ng-select
                                    placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.ANSWER_TYPE' | translate }}*"
                                    formControlName="answer_type"
                                    [clearable]="false"
                                    appendTo="body"
                                    [required]="!questionField.get('is_field').value"
                                    [disabled]="isPublished"
                                    (change)="onChangeAnswerType(segmentIndex, questionIndex, $event)"
                                  >
                                    <ng-option
                                      *ngFor="let questionAnswerType of questionnaireConsts.questionAnswerTypesOneTimeForm"
                                      [value]="questionAnswerType.key"
                                      [disabled]="isPublished"
                                    >
                                      {{ 'QUESTION_ANSWER_TYPE.' + questionAnswerType.name.toUpperCase() | translate }}
                                    </ng-option>
                                  </ng-select>
                                  <mat-error
                                    class="manual-error"
                                    *ngIf="
                                      questionField?.get('answer_type')?.hasError('required') &&
                                      questionField?.get('answer_type')?.invalid &&
                                      questionField?.get('answer_type')?.touched
                                    "
                                  >
                                    {{ 'This field is required' | translate }}
                                  </mat-error>
                                </ng-container>
                              </div>
                            </ng-container>

                            <!-- Display the field dropdown if field is true -->
                            <ng-container>
                              <div [style.display]="questionField.get('is_field').value ? 'block' : 'none'" class="p-col-4">
                                <label
                                  class="float-label"
                                  [style.visibility]="questionField.get('field_type').value ? 'visible' : 'hidden'"
                                >
                                  {{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_TYPE' | translate }}
                                </label>
                                <ng-select
                                  *ngIf="templateStepForm?.get('step_type').value === 'question_and_field'"
                                  placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_TYPE' | translate }}*"
                                  formControlName="field_type"
                                  [clearable]="false"
                                  appendTo="body"
                                  [required]="questionField?.get('is_field').value"
                                  [disabled]="isPublished"
                                >
                                  <ng-container *ngIf="templateType === 'alumni'">
                                    <ng-option
                                      [disabled]="isPublished"
                                      *ngFor="let field of questionnaireConsts?.questionnaireFieldsForAlumni"
                                      [value]="field"
                                    >
                                      {{ 'FORM_BUILDER_FIELD.' + field | translate }}
                                    </ng-option>
                                  </ng-container>

                                  <ng-container *ngIf="templateType === 'teacher_contract'">
                                    <ng-option
                                      [disabled]="isPublished"
                                      *ngFor="let field of questionnaireConsts?.questionnaireFieldsForTeacher"
                                      [value]="field"
                                    >
                                      {{ 'FORM_BUILDER_FIELD.' + field | translate }}
                                    </ng-option>
                                  </ng-container>

                                  <ng-container *ngIf="templateType === 'fc_contract'">
                                    <ng-option
                                      [disabled]="isPublished"
                                      *ngFor="let field of questionnaireConsts?.questionnaireFieldsForContract"
                                      [value]="field"
                                    >
                                      {{ 'FORM_BUILDER_FIELD.' + field | translate }}
                                    </ng-option>
                                  </ng-container>

                                  <ng-container *ngIf="templateType === 'student_admission'">
                                    <ng-option
                                      [disabled]="isPublished"
                                      *ngFor="let field of questionnaireConsts?.questionAndFieldType"
                                      [value]="field"
                                    >
                                      {{ 'FORM_BUILDER_FIELD.' + field | translate }}
                                    </ng-option>
                                  </ng-container>

                                  <ng-container *ngIf="templateType === 'admission_document' || templateType === 'one_time_form'">
                                    <ng-option
                                      [disabled]="isPublished"
                                      *ngFor="let field of questionnaireConsts?.questionAndFieldAdmissionDocumentType"
                                      [value]="field"
                                    >
                                      {{ 'FORM_BUILDER_FIELD.' + field | translate }}
                                    </ng-option>
                                  </ng-container>
                                </ng-select>
                                <mat-error
                                  class="manual-error"
                                  *ngIf="
                                    questionField?.get('field_type')?.hasError('required') &&
                                    questionField?.get('field_type')?.invalid &&
                                    questionField?.get('field_type')?.touched
                                  "
                                >
                                  {{ 'This field is required' | translate }}
                                </mat-error>
                              </div>
                            </ng-container>

                            <!-- Always display the position regardless field true/false -->
                            <ng-container>
                              <div
                                class="p-col-4"
                                [style.visibility]="questionField.get('answer_type').value === 'long_text' ? 'hidden' : 'visible'"
                              >
                                <label
                                  class="float-label"
                                  [style.visibility]="questionField.get('field_position').value ? 'visible' : 'hidden'"
                                >
                                  {{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_POSITION' | translate }}
                                </label>
                                <ng-select
                                  placeholder="{{ 'MENTOREVALUATION.QUESTIONNAIRE.FIELD_POSITION' | translate }}*"
                                  formControlName="field_position"
                                  [clearable]="false"
                                  appendTo="body"
                                  [required]="questionField.get('answer_type').value !== 'long_text'"
                                  [disabled]="isPublished"
                                >
                                  <ng-option *ngFor="let position of questionnaireConsts.questionPositions" [value]="position">{{
                                    'ERP_009_TEACHER_CONTRACT.POSITION.' + position | translate
                                  }}</ng-option>
                                </ng-select>
                                <mat-error
                                  class="manual-error"
                                  *ngIf="
                                    questionField?.get('field_position')?.hasError('required') &&
                                    questionField?.get('field_position')?.invalid &&
                                    questionField?.get('field_position')?.touched
                                  "
                                >
                                  {{ 'This field is required' | translate }}
                                </mat-error>
                              </div>
                            </ng-container>

                            <div
                              [style.display]="
                                !questionField.get('is_field').value && questionField.get('answer_type').value === 'numeric'
                                  ? 'contents'
                                  : 'none'
                              "
                              formGroupName="numeric_validation"
                            >
                              <div class="p-col-fixed p-col-align-center pad-r-md">
                                {{ 'Validation' | translate }}
                              </div>
                              <div class="p-col-3">
                                <mat-form-field color="accent">
                                  <mat-label>{{ 'Condition' | translate }}</mat-label>
                                  <mat-select
                                    disableOptionCentering
                                    formControlName="condition"
                                    [required]="
                                      !questionField.get('is_field').value && questionField.get('answer_type').value === 'numeric'
                                    "
                                    panelClass="custom-matselect-dropdown"
                                  >
                                    <mat-option *ngFor="let condition of questionnaireConsts.numericConditions" [value]="condition">
                                      {{ condition | translate }}
                                    </mat-option>
                                  </mat-select>
                                  <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                </mat-form-field>
                              </div>
                              <ng-container
                                *ngIf="
                                  questionField.get('numeric_validation').get('condition').value === 'Between' ||
                                  questionField.get('numeric_validation').get('condition').value === 'Not between'
                                "
                              >
                                <div class="p-col-2">
                                  <mat-form-field color="accent">
                                    <mat-label>{{ 'Number' | translate }}</mat-label>
                                    <input
                                      matInput
                                      type="number"
                                      (wheel)="onWheel($event)"
                                      formControlName="min_number"
                                      [required]="
                                        !questionField.get('is_field').value &&
                                        questionField.get('answer_type').value === 'numeric' &&
                                        (questionField.get('numeric_validation').get('condition').value === 'Between' ||
                                          questionField.get('numeric_validation').get('condition').value === 'Not between')
                                      "
                                    />
                                    <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                  </mat-form-field>
                                </div>
                                <div class="p-col-2">
                                  <mat-form-field color="accent">
                                    <mat-label>{{ 'Number' | translate }}</mat-label>
                                    <input
                                      matInput
                                      type="number"
                                      (wheel)="onWheel($event)"
                                      formControlName="max_number"
                                      [required]="
                                        !questionField.get('is_field').value &&
                                        questionField.get('answer_type').value === 'numeric' &&
                                        (questionField.get('numeric_validation').get('condition').value === 'Between' ||
                                          questionField.get('numeric_validation').get('condition').value === 'Not between')
                                      "
                                    />
                                    <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                  </mat-form-field>
                                </div>
                              </ng-container>
                              <div
                                class="p-col-2"
                                [style.display]="
                                  questionField.value?.numeric_validation?.condition === 'Whole number' ||
                                  questionField.get('numeric_validation').get('condition').value === 'Between' ||
                                  questionField.get('numeric_validation').get('condition').value === 'Not between'
                                    ? 'none'
                                    : ''
                                "
                              >
                                <mat-form-field color="accent">
                                  <mat-label>{{ 'Number' | translate }}</mat-label>
                                  <input
                                    matInput
                                    type="number"
                                    (wheel)="onWheel($event)"
                                    formControlName="number"
                                    [required]="
                                      !questionField.get('is_field').value &&
                                      questionField.get('answer_type').value === 'numeric' &&
                                      questionField.get('numeric_validation').get('condition').value !== 'Whole number' &&
                                      questionField.get('numeric_validation').get('condition').value !== 'Between' &&
                                      questionField.get('numeric_validation').get('condition').value !== 'Not between'
                                    "
                                  />
                                  <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                </mat-form-field>
                              </div>

                              <div class="p-col">
                                <mat-form-field color="accent">
                                  <mat-label>{{ 'Custom Error Text' | translate }}</mat-label>
                                  <input
                                    matInput
                                    type="text"
                                    formControlName="custom_error_text"
                                    [required]="
                                      !questionField.get('is_field').value && questionField.get('answer_type').value === 'numeric'
                                    "
                                  />
                                  <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                </mat-form-field>
                              </div>
                            </div>

                            <div
                              formGroupName="multiple_option_validation"
                              [style.display]="
                                (!questionField.get('is_field').value && questionField.get('answer_type').value === 'multiple_option') ||
                                questionField.get('answer_type').value === 'dropdown_multiple_option'
                                  ? 'contents'
                                  : 'none'
                              "
                            >
                              <div class="p-col-fixed p-col-align-center pad-r-md">
                                {{ 'Validation' | translate }}
                              </div>
                              <div class="p-col-3">
                                <mat-form-field color="accent">
                                  <mat-label>{{ 'Selection Min/Max' | translate }}</mat-label>
                                  <mat-select
                                    disableOptionCentering
                                    formControlName="condition"
                                    [required]="
                                      (!questionField.get('is_field').value &&
                                        questionField.get('answer_type').value === 'multiple_option') ||
                                      questionField.get('answer_type').value === 'dropdown_multiple_option'
                                    "
                                    panelClass="custom-matselect-dropdown"
                                  >
                                    <mat-option *ngFor="let condition of questionnaireConsts.multipleOptionConditions" [value]="condition">
                                      {{ condition | translate }}
                                    </mat-option>
                                  </mat-select>
                                  <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                </mat-form-field>
                              </div>
                              <div class="p-col-2">
                                <mat-form-field color="accent">
                                  <mat-label>{{ 'Number' | translate }}</mat-label>
                                  <input
                                    matInput
                                    type="number"
                                    (wheel)="onWheel($event)"
                                    formControlName="number"
                                    [required]="
                                      (!questionField.get('is_field').value &&
                                        questionField.get('answer_type').value === 'multiple_option') ||
                                      questionField.get('answer_type').value === 'dropdown_multiple_option'
                                    "
                                  />
                                  <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                </mat-form-field>
                              </div>
                              <div class="p-col">
                                <mat-form-field color="accent">
                                  <mat-label>{{ 'Custom Error Text' | translate }}</mat-label>
                                  <input
                                    matInput
                                    type="text"
                                    formControlName="custom_error_text"
                                    [required]="
                                      (!questionField.get('is_field').value &&
                                        questionField.get('answer_type').value === 'multiple_option') ||
                                      questionField.get('answer_type').value === 'dropdown_multiple_option'
                                    "
                                  />
                                  <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                </mat-form-field>
                              </div>
                            </div>

                            <div
                              [style.display]="
                                !questionField.get('is_field').value &&
                                [
                                  'single_option',
                                  'single_option_diploma',
                                  'dropdown_single_option',
                                  'single_option_readmission_yes_or_no',
                                  'single_option_reason_not_readmission'
                                ].includes(questionField.get('answer_type').value)
                                  ? 'contents'
                                  : 'none'
                              "
                            >
                              <div class="p-col-12">
                                <mat-slide-toggle
                                  formControlName="is_router_on"
                                  (change)="onChangeRouter($event, segmentIndex, questionIndex, questionField.get('answer_type').value)"
                                  [disabled]="getQuestionFieldFormArray(segmentIndex)?.at(questionIndex)?.get('options')?.value?.length ? false : true"
                                >
                                  {{ questionField.get('is_router_on').value ? ('Router ON' | translate) : ('Router OFF' | translate) }}
                                </mat-slide-toggle>
                              </div>
                            </div>

                            <!-- ERP_050 Teacher Improvement -->
                            <div
                              [style.display]="
                                isMultipleContract &&
                                listMultipleContractType?.includes(templateType) &&
                                !questionField.get('is_field').value &&
                                [
                                  'single_option',
                                  'dropdown_single_option',
                                ].includes(questionField.get('answer_type').value)
                                  ? 'contents'
                                  : 'none'
                              "
                            >
                              <div class="p-col-12">
                                <mat-slide-toggle
                                  formControlName="is_router_contract_on"
                                  (change)="checkRouterContractAlreadyUsed($event, segmentIndex, questionIndex, questionField.get('answer_type').value, 'contract')"
                                  [disabled]="getQuestionFieldFormArray(segmentIndex)?.at(questionIndex)?.get('options')?.value?.length ? false : true"
                                >
                                  {{
                                    questionField.get('is_router_contract_on').value
                                      ? ('Router ON Contract' | translate)
                                      : ('Router OFF Contract' | translate)
                                  }}
                                </mat-slide-toggle>
                              </div>
                            </div>
                            <!-- ERP_050 Teacher Improvement -->

                            <div
                              [style.display]="
                                !questionField.get('is_field').value &&
                                (questionField.get('answer_type').value === 'short_text' ||
                                  questionField.get('answer_type').value === 'long_text')
                                  ? 'contents'
                                  : 'none'
                              "
                              formGroupName="text_validation"
                            >
                              <div class="p-col-fixed p-col-align-center pad-r-md">
                                {{ 'Length' | translate }}
                              </div>
                              <div class="p-col-3">
                                <mat-form-field color="accent">
                                  <mat-label>{{ 'Condition' | translate }}</mat-label>
                                  <mat-select
                                    disableOptionCentering
                                    formControlName="condition"
                                    [required]="
                                      !questionField.get('is_field').value &&
                                      (questionField.get('answer_type').value === 'short_text' ||
                                        questionField.get('answer_type').value === 'long_text')
                                    "
                                    panelClass="custom-matselect-dropdown"
                                  >
                                    <mat-option *ngFor="let condition of questionnaireConsts.textValidationCondition" [value]="condition">
                                      {{ condition | translate }}
                                    </mat-option>
                                  </mat-select>
                                  <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                </mat-form-field>
                              </div>
                              <div class="p-col-2">
                                <mat-form-field color="accent">
                                  <mat-label>{{ 'Number' | translate }}</mat-label>
                                  <input
                                    matInput
                                    type="number"
                                    (wheel)="onWheel($event)"
                                    formControlName="number"
                                    [required]="
                                      !questionField.get('is_field').value &&
                                      (questionField.get('answer_type').value === 'short_text' ||
                                        questionField.get('answer_type').value === 'long_text')
                                    "
                                  />
                                  <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                </mat-form-field>
                              </div>
                              <div class="p-col">
                                <mat-form-field color="accent">
                                  <mat-label>{{ 'Custom Error Text' | translate }}</mat-label>
                                  <input
                                    matInput
                                    type="text"
                                    formControlName="custom_error_text"
                                    [required]="
                                      !questionField.get('is_field').value &&
                                      (questionField.get('answer_type').value === 'short_text' ||
                                        questionField.get('answer_type').value === 'long_text')
                                    "
                                  />
                                  <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                </mat-form-field>
                              </div>
                            </div>

                            <!-- For Question Name, only displayed if field false -->
                            <ng-container>
                              <div [style.display]="!questionField.get('is_field').value ? 'block' : 'none'" class="p-col-12">
                                <mat-form-field>
                                  <input
                                    matInput
                                    formControlName="question_label"
                                    [placeholder]="'Question Label' | translate"
                                    type="text"
                                    [readonly]="questionField.get('answer_type').value === 'single_option_diploma'"
                                    [required]="!questionField.get('is_field').value"
                                  />
                                  <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                </mat-form-field>
                              </div>
                            </ng-container>
                          </div>

                          <div
                            fxLayout="row"
                            [style.display]="checkIsParentChild(questionField?.value) ? 'flex' : 'none'"
                            *ngIf="questionField.get('answer_type').value === 'parent_child_option'"
                          >
                            <div class="p-col-8">
                              <mat-form-field #parentChildOptionFormField color="accent" style="width: 100%">
                                <input
                                  #parentChildOption
                                  matInput
                                  type="text"
                                  [placeholder]="'MENTOREVALUATION.QUESTIONNAIRE.OPTION.title' | translate"
                                  (focusout)="
                                    !parentChildOption.value && !questionField?.get('parent_child_options')?.value?.length
                                      ? parentChildOptionFormField?._elementRef?.nativeElement?.classList?.add('mat-form-field-invalid')
                                      : parentChildOptionFormField?._elementRef?.nativeElement?.classList?.remove('mat-form-field-invalid')
                                  "
                                  (keydown)="
                                    parentChildOptionFormField?._elementRef?.nativeElement?.classList?.remove('mat-form-field-invalid')
                                  "
                                  [required]="
                                    checkIsParentChild(questionField?.value) && questionField?.get('parent_child_options')?.value?.length
                                  "
                                />
                              </mat-form-field>
                              <mat-error
                                *ngIf="
                                  parentChildOptionFormField?._elementRef?.nativeElement?.classList?.contains('mat-form-field-invalid')
                                "
                                >{{ 'This field is required' | translate }}</mat-error
                              >
                            </div>
                            <div class="p-col-4">
                              <button
                                mat-mini-fab
                                color="primary"
                                type="button"
                                (click)="addMoreAnswers(segmentIndex, questionIndex, parentChildOption)"
                              >
                                <mat-icon>add</mat-icon>
                              </button>
                            </div>
                          </div>

                          <ul
                            style="flex-direction: column; list-style: none"
                            [style.display]="checkIsParentChild(questionField?.value) ? 'flex' : 'none'"
                          >
                            <li *ngFor="let option of questionField?.value?.parent_child_options; let optionIndex = index">
                              <ms-step-parent-child-nesting
                                [parent_child_options]="option"
                                [question]="questionField.value"
                                [optionIndex]="optionIndex"
                                [formBuilderForm]="templateStepForm"
                                [segmentIndex]="segmentIndex"
                                [questionIndex]="questionIndex"
                                [isViewOnly]="false"
                                [parentAnswerType]="parentAnswerType"
                              ></ms-step-parent-child-nesting>
                            </li>
                          </ul>

                          <div
                            class="p-grid p-align-center"
                            [style.display]="checkIsMutiOption(questionField?.value) ? 'flex' : 'none'"
                            *ngIf="
                              questionField.get('answer_type').value !== 'single_option_diploma' &&
                              questionField.get('answer_type').value !== 'single_option_readmission_yes_or_no'
                            "
                          >
                            <div class="p-col">
                              <mat-form-field #formField color="accent" style="width: 100%">
                                <input
                                  #optionInput
                                  matInput
                                  type="text"
                                  [placeholder]="'MENTOREVALUATION.QUESTIONNAIRE.OPTION.title' | translate"
                                  (focusout)="
                                    !optionInput?.value && !questionField?.get('options')?.value?.length
                                      ? formField?._elementRef?.nativeElement?.classList?.add('mat-form-field-invalid')
                                      : formField?._elementRef?.nativeElement?.classList?.remove('mat-form-field-invalid')
                                  "
                                  (keydown)="formField?._elementRef?.nativeElement?.classList?.remove('mat-form-field-invalid')"
                                  [required]="checkIsMutiOption(questionField?.value) && !questionField?.get('options')?.value?.length"
                                />
                              </mat-form-field>
                              <mat-error
                                class="manual-error"
                                *ngIf="formField?._elementRef?.nativeElement?.classList?.contains('mat-form-field-invalid')"
                                >{{ 'This field is required' | translate }}</mat-error
                              >
                            </div>
                            <div class="p-col-fixed">
                              <button
                                [disabled]="isPublished || !optionInput.value"
                                mat-mini-fab
                                color="primary"
                                type="button"
                                type="button"
                                (click)="addMoreOptions(segmentIndex, questionIndex, optionInput); optionInput.value = ''"
                              >
                                <mat-icon>add</mat-icon>
                              </button>
                            </div>
                          </div>

                          <div
                            class="p-grid"
                            *ngIf="
                              checkIsMutiOption(questionField?.value) &&
                              questionField.get('answer_type').value !== 'single_option_readmission_yes_or_no'
                            "
                          >
                            <ng-container *ngFor="let option of getOptionsFormArrayFrom(questionField).controls; let optionIndex = index">
                              <div class="p-col-12 no-padding" [formGroup]="option">
                                <div class="p-grid p-align-center">
                                  <div class="p-col-6">
                                    <span style="text-align: right">{{ optionIndex + 1 }}) {{ option?.value?.option_name }} </span>
                                  </div>
                                  <div class="p-col-fixed">
                                    <button
                                      [disabled]="isPublished"
                                      type="button"
                                      mat-icon-button
                                      matTooltip="{{ 'course_sequence.Remove' | translate }}"
                                      (click)="removeOption(segmentIndex, questionIndex, optionIndex, questionField)"
                                      *ngIf="questionField.get('answer_type').value !== 'single_option_diploma'"
                                    >
                                      <mat-icon>delete</mat-icon>
                                    </button>
                                  </div>
                                  <div class="p-col no-padding">
                                    <div class="p-col-12 no-padding">
                                      <div class="p-grid">
                                        <div
                                          [ngClass]="questionField.get('is_router_on')?.value && !questionField.get('is_router_contract_on')?.value ? 'p-col-12 no-padding' :
                                          questionField.get('is_router_on')?.value && questionField.get('is_router_contract_on')?.value ? 'p-col-6 no-padding-y' : 'none'">
                                          <ng-container *ngIf="questionField.get('is_router_on')?.value">
                                            <mat-form-field color="accent">
                                              <mat-label>{{ 'Go to step' | translate }} </mat-label>
                                              <input matInput formControlName="additional_step_name" [matAutocomplete]="nextStepAuto"
                                                (keyup)="onNextStepType($event, questionField, optionIndex, '')" (blur)="checkValueRouterOn(questionField, optionIndex)" />
                                              <mat-autocomplete #nextStepAuto [displayWith]="displayNextStepWithFn.bind(this)" [panelWidth]="'fit'">
                                                <mat-option *ngFor="let option of filteredConditionalStepsDropdown" [value]="option?.step_title"
                                                  (click)="onSelectNextStepAt(optionIndex, questionField, option)">
                                                  {{ option?.step_title }}
                                                </mat-option>
                                                <mat-option [value]="'Continue Next Step'"
                                                  (mousedown)="onSelectNextStepAt(optionIndex, questionField, 'Continue Next Step')">
                                                  {{ 'Continue Next Step' | translate }}
                                                </mat-option>
                                                <mat-option [value]="'Go To Final Step'"
                                                  (mousedown)="onSelectNextStepAt(optionIndex, questionField, 'Go To Final Step')">
                                                  {{ 'Go To Final Step' | translate }}
                                                </mat-option>
                                                <mat-option [value]="'Go To Final Message'"
                                                  (mousedown)="onSelectNextStepAt(optionIndex, questionField, 'Go To Final Message')">
                                                  {{ 'Go To Final Message' | translate }}
                                                </mat-option>
                                              </mat-autocomplete>
                                              <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                            </mat-form-field>
                                          </ng-container>
                                        </div>
                                        <div [ngClass]="!questionField.get('is_router_on')?.value && questionField.get('is_router_contract_on')?.value ? 'p-col-12' :
                                        questionField.get('is_router_on')?.value && questionField.get('is_router_contract_on')?.value ? 'p-col-6 no-padding-y' : 'none'">
                                          <!-- ERP_050 Improvement Router Contract-->
                                          <ng-container *ngIf="questionField.get('is_router_contract_on')?.value">
                                            <mat-form-field color="accent">
                                              <mat-label>{{ 'Go to contract' | translate }}</mat-label>
                                              <input matInput formControlName="additional_contract_name" [matAutocomplete]="nextStepAuto"
                                                (keyup)="onNextStepType($event, questionField, optionIndex, 'contract')" (blur)="checkValueRouterOnContract(questionField, optionIndex)"/>
                                              <mat-autocomplete #nextStepAuto [displayWith]="displayNextStepWithFn.bind(this)" [panelWidth]="'fit'">
                                                <mat-option *ngFor="let option of filteredConditionalStepsDropdownContract" [value]="option?.step_title"
                                                  (click)="onSelectNextStepAt(optionIndex, questionField, option, 'contract')">
                                                  {{ option?.step_title }}
                                                </mat-option>
                                              </mat-autocomplete>
                                              <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                            </mat-form-field>
                                          </ng-container>
                                          <!-- ERP_050 Improvement Router Contract-->
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </ng-container>
                          </div>

                          <div class="p-grid" *ngIf="questionField.get('answer_type').value === 'single_option_readmission_yes_or_no'">
                            <ng-container *ngFor="let option of getOptionsFormArrayFrom(questionField).controls; let optionIndex = index">
                              <div class="p-col-12 no-padding" [formGroup]="option">
                                <div class="p-grid p-align-center">
                                  <div class="p-col-2" *ngIf="optionIndex === 0">
                                    <div style="text-align: left">{{ optionIndex + 1 }}) {{ 'YES' | translate }}</div>
                                  </div>
                                  <div class="p-col-2" *ngIf="optionIndex === 1">
                                    <div style="text-align: left">{{ optionIndex + 1 }}) {{ 'NO' | translate }}</div>
                                  </div>
                                  <div class="p-col-fixed">
                                    <mat-form-field color="accent">
                                      <mat-label>{{ 'Answer Label' | translate }}</mat-label>
                                      <input
                                        matInput
                                        type="text"
                                        [value]="option?.value?.option_name"
                                        (keyup)="handleChangeAnswerLabel($event, segmentIndex, questionIndex, optionIndex)"
                                        [required]="
                                          !questionField.get('is_field').value &&
                                          questionField.get('answer_type').value === 'single_option_readmission_yes_or_no'
                                        "
                                      />
                                      <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                    </mat-form-field>
                                  </div>
                                  <div class="p-col no-padding" *ngIf="questionField.get('is_router_on')?.value">
                                    <mat-form-field color="accent">
                                      <mat-label>{{ 'Go to step' | translate }}</mat-label>
                                      <input
                                        matInput
                                        formControlName="additional_step_name"
                                        [matAutocomplete]="nextStepAuto"
                                        (keyup)="onNextStepType($event, questionField, optionIndex, '')"
                                        (blur)="checkValueRouterOn(questionField, optionIndex)"
                                      />
                                      <mat-autocomplete
                                        #nextStepAuto
                                        [displayWith]="displayNextStepWithFn.bind(this)"
                                        [panelWidth]="'fit'"
                                      >
                                        <mat-option
                                          *ngFor="let option of filteredConditionalStepsDropdown"
                                          [value]="option?.step_title"
                                          (click)="onSelectNextStepAt(optionIndex, questionField, option)"
                                        >
                                          {{ option?.step_title }}
                                        </mat-option>
                                        <mat-option
                                          [value]="'Continue Next Step'"
                                          (click)="onSelectNextStepAt(optionIndex, questionField, 'Continue Next Step')"
                                        >
                                          {{ 'Continue Next Step' | translate }}
                                        </mat-option>
                                        <mat-option
                                          [value]="'Go To Final Step'"
                                          (click)="onSelectNextStepAt(optionIndex, questionField, 'Go To Final Step')"
                                        >
                                          {{ 'Go To Final Step' | translate }}
                                        </mat-option>
                                        <mat-option
                                          [value]="'Go To Final Message'"
                                          (click)="onSelectNextStepAt(optionIndex, questionField, 'Go To Final Message')"
                                        >
                                          {{ 'Go To Final Message' | translate }}
                                        </mat-option>
                                      </mat-autocomplete>
                                      <mat-error>{{ 'This field is required' | translate }}</mat-error>
                                    </mat-form-field>
                                  </div>
                                </div>
                              </div>
                            </ng-container>
                          </div>
                        </mat-card-content>

                        <!-- If step type is campus validation -->
                        <mat-card-content
                          *ngIf="templateStepForm?.get('step_type').value === 'campus_validation'"
                          [formGroupName]="questionIndex"
                        >
                          <div class="p-grid" formGroupName="special_question">
                            <div class="p-col-12 no-padding-y">
                              <div class="ckeditor">
                                <ckeditor
                                  formControlName="campus_validation"
                                  #editor
                                  [editor]="Editor"
                                  (ready)="onReady($event)"
                                  [config]="config"
                                  [disabled]="isPublished"
                                ></ckeditor>
                              </div>
                            </div>
                          </div>
                        </mat-card-content>

                        <mat-card-content
                          *ngIf="templateStepForm?.get('step_type').value === 'document_to_validate'"
                          [formGroupName]="questionIndex"
                        >
                          <ng-container formGroupName="special_question">
                            <div class="p-col-12" style="padding-top: 0px">
                              <ng-select
                                formControlName="document_acceptance_type"
                                [clearable]="false"
                                appendTo="body"
                                required
                                (change)="handleDocumentSelected($event, segmentIndex, questionIndex)"
                                placeholder="{{ 'Select Document to Validate' | translate }}*"
                                [disabled]="isPublished"
                              >
                                <ng-option *ngFor="let type of docListType" [value]="type">{{ type | translate }}</ng-option>
                              </ng-select>
                            </div>

                            <!-- if step_type === document_to_validate and choose text editor -->
                            <div style="width: 99% !important" class="p-col-12 no-padding-y" *ngIf="selectedDocType === 'ck_editor'">
                              <div class="ckeditor">
                                <ckeditor
                                  #editor
                                  [editor]="Editor"
                                  formControlName="document_acceptance_text"
                                  (ready)="onReady($event)"
                                  [config]="configTypeCondition"
                                  [disabled]="isPublished"
                                ></ckeditor>
                              </div>
                            </div>

                            <!-- if step_type === document_to_validate and choose upload pdf -->
                            <div class="p-col-12 no-padding-y" *ngIf="selectedDocType === 'upload_pdf'">
                              <ng-container *ngIf="!listUploadDocumentPDF">
                                <button mat-raised-button color="accent" (click)="openUploadWindow()">
                                  <mat-icon>file_upload</mat-icon> {{ 'Upload PDF for user to accept' | translate }}
                                </button>
                                <input
                                  #fileUploadDoc
                                  type="file"
                                  accept=".pdf"
                                  class="hidden"
                                  (change)="chooseFile($event, segmentIndex, questionIndex)"
                                />
                              </ng-container>
                              <div class="p-grid" *ngIf="listUploadDocumentPDF" style="padding-top: 15px">
                                <input
                                  #fileUploadDoc
                                  type="file"
                                  accept=".pdf"
                                  class="hidden"
                                  (change)="chooseFile($event, segmentIndex, questionIndex)"
                                />
                                <div class="p-col-2">
                                  <button (click)="openUploadWindow()" mat-icon-button matTooltip="{{ 'Edit' | translate }}">
                                    <mat-icon style="color: black">edit</mat-icon>
                                  </button>
                                  <button
                                    (click)="deletePDF(segmentIndex, questionIndex)"
                                    mat-icon-button
                                    matTooltip="{{ 'Delete' | translate }}"
                                  >
                                    <mat-icon style="color: black">delete</mat-icon>
                                  </button>
                                </div>
                                <div class="p-col-10" style="margin-top: 6px">
                                  {{ listUploadDocumentPDF }}
                                </div>
                              </div>
                            </div>

                            <!-- if step_type === document_to_validate and choose from builder -->
                            <ng-container *ngIf="selectedDocType === 'doc_builder'">
                              <div class="p-col-12 no-padding-y">
                                <ng-select
                                  formControlName="document_builder_id"
                                  [clearable]="false"
                                  appendTo="body"
                                  [required]="selectedDocType === 'doc_builder'"
                                  placeholder="{{ 'Select Document from Document Builder' | translate }}*"
                                  [disabled]="isPublished"
                                >
                                  <ng-option *ngFor="let doc of documentBuilders" [value]="doc._id">{{
                                    doc.document_builder_name
                                  }}</ng-option>
                                </ng-select>
                              </div>
                            </ng-container>
                          </ng-container>
                        </mat-card-content>

                        <!-- if step type summary -->
                        <mat-card-content
                          *ngIf="this.templateStepForm.get('step_type').value === 'summary'"
                          [formGroupName]="questionIndex"
                        >
                          <div class="p-grid" formGroupName="special_question">
                            <div class="p-col-12 no-padding-y">
                              <!-- Header -->
                              <div class="p-grid">
                                <div class="p-col-6">
                                  <label>{{ 'Header of the summary' | translate }}</label>
                                </div>
                              </div>
                              <div class="p-col-12 no-padding-y">
                                <div class="ckeditor">
                                  <ckeditor
                                    formControlName="summary_header"
                                    #editor
                                    [editor]="Editor"
                                    (ready)="onReady($event)"
                                    [config]="config"
                                    [disabled]="isPublished"
                                  ></ckeditor>
                                </div>
                              </div>
                              <!-- Footer -->
                              <div class="p-grid">
                                <div class="p-col-6">
                                  <label>{{ 'Footer of the summary' | translate }}</label>
                                </div>
                              </div>
                              <div class="p-col-12 no-padding-y">
                                <div class="ckeditor">
                                  <ckeditor
                                    formControlName="summary_footer"
                                    #editor
                                    [editor]="Editor"
                                    (ready)="onReady($event)"
                                    [config]="config"
                                    [disabled]="isPublished"
                                  ></ckeditor>
                                </div>
                              </div>
                            </div>
                          </div>
                        </mat-card-content>
                        <!-- if step type step_summary END  -->

                        <!-- if step type final_message -->
                        <mat-card-content
                          *ngIf="templateStepForm?.get('step_type').value === 'final_message'"
                          [formGroupName]="questionIndex"
                        >
                          <div class="p-grid" formGroupName="final_message_question">
                            <div class="p-col-12 no-padding-y">
                              <!-- Header -->
                              <div class="p-grid">
                                <div class="p-col-6">
                                  <label>{{ 'Header of the summary' | translate }}</label>
                                </div>
                              </div>
                              <div class="p-col-12 no-padding-y">
                                <div class="ckeditor">
                                  <ckeditor
                                    formControlName="final_message_summary_header"
                                    #editor
                                    [editor]="Editor"
                                    (ready)="onReady($event)"
                                    [config]="config"
                                    [disabled]="isPublished"
                                  ></ckeditor>
                                </div>
                              </div>
                              <!-- Footer -->
                              <div class="p-grid">
                                <div class="p-col-6">
                                  <label>{{ 'Footer of the summary' | translate }}</label>
                                </div>
                              </div>
                              <div class="p-col-12 no-padding-y">
                                <div class="ckeditor">
                                  <ckeditor
                                    formControlName="final_message_summary_footer"
                                    #editor
                                    [editor]="Editor"
                                    (ready)="onReady($event)"
                                    [config]="config"
                                    [disabled]="isPublished"
                                  ></ckeditor>
                                </div>
                              </div>

                              <div class="p-grid">
                                <div class="p-col-6">
                                  <label>{{ 'Image' | translate }}</label> <br />
                                  <button mat-raised-button color="accent" (click)="image.click()" [disabled]="isPublished">
                                    <mat-icon class="mat-icon-default">add</mat-icon>
                                    {{ 'Select File' | translate }}
                                  </button>
                                  <br />
                                  <input
                                    #image
                                    type="file"
                                    accept=".jpeg, .jpg, .png"
                                    hidden
                                    [disabled]="isPublished"
                                    (change)="chooseFile($event, segmentIndex, questionIndex); image.value = ''"
                                  />
                                  <img
                                    src="{{ serverimgPath }}{{
                                      questionField.get('final_message_question').get('final_message_image').get('s3_file_name').value
                                    }}"
                                    *ngIf="questionField.get('final_message_question').get('final_message_image').get('s3_file_name').value"
                                    maxWidth="300px"
                                  />
                                  <br />
                                  <button
                                    *ngIf="questionField.get('final_message_question').get('final_message_image').get('s3_file_name').value"
                                    matTooltip="{{ 'course_sequence.Remove' | translate }}"
                                    (click)="removeImage(segmentIndex, questionIndex)"
                                    mat-icon-button
                                    class="small-icon"
                                    color="red"
                                    [disabled]="isPublished"
                                  >
                                    <mat-icon>remove</mat-icon>
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </mat-card-content>
                        <!-- if step type final_message END  -->
                      </div>
                    </mat-card>
                  </div>
                </div>
              </ng-container>
            </mat-expansion-panel>
          </mat-accordion>
        </div>
      </div>
    </fieldset>
  </div>

  <div class="p-col-6 preview-side preview-side" style="padding-left: 1rem" *ngIf="templateStepForm?.get('step_type').value">
    <mat-horizontal-stepper #stepperForm selectedIndex="0">
      <ng-template matStepperIcon="number" let-index="index">
        {{ stepIndex + 1 }}
      </ng-template>

      <mat-step disableRipple="true" label="{{ templateStepForm.get('step_title').value }}">
        <div [ngSwitch]="templateStepForm?.get('step_type').value">
          <ms-question-form-preview *ngSwitchCase="'question_and_field'" [currentStepIndex]="stepIndex"></ms-question-form-preview>
          <ms-question-form-preview *ngSwitchCase="'academic_journey'" [currentStepIndex]="stepIndex"></ms-question-form-preview>
          <ms-document-form-preview *ngSwitchCase="'document_expected'" [currentStepIndex]="stepIndex"></ms-document-form-preview>
          <ms-condition-acceptance-form-preview
            *ngSwitchCase="'condition_acceptance'"
            [currentStepIndex]="stepIndex"
          ></ms-condition-acceptance-form-preview>
          <ms-condition-acceptance-form-preview
            *ngSwitchCase="'document_to_validate'"
            [currentStepIndex]="stepIndex"
          ></ms-condition-acceptance-form-preview>
          <ms-campus-validation-form-preview
            *ngSwitchCase="'campus_validation'"
            [currentStepIndex]="stepIndex"
          ></ms-campus-validation-form-preview>
          <ms-final-messages-preview *ngSwitchCase="'final_message'" [currentStepIndex]="stepIndex"></ms-final-messages-preview>
          <ms-financement-form-preview *ngSwitchCase="'finance'" [currentStepIndex]="stepIndex"></ms-financement-form-preview>
          <ms-scholarship-fees-form-preview
            *ngSwitchCase="'scholarship_fee'"
            [currentStepIndex]="stepIndex"
          ></ms-scholarship-fees-form-preview>
          <ms-modality-payment-form-preview
            *ngSwitchCase="'modality_payment'"
            [currentStepIndex]="stepIndex"
          ></ms-modality-payment-form-preview>
          <ms-down-payment-form-preview *ngSwitchCase="'down_payment_mode'" [currentStepIndex]="stepIndex"></ms-down-payment-form-preview>
        </div>
      </mat-step>
    </mat-horizontal-stepper>
  </div>
</div>

<div *ngIf="isWaitingForResponse" class="loading-indicator">
  <mat-progress-spinner mode="indeterminate" color="accent"></mat-progress-spinner>
</div>
